<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> Your Inbound 2025 Assistant</title>
  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --border:#e5e7eb;
      --primary:#111827;
      --primary-50:#f3f4f6;
      --blue:#1d4ed8;
      --shadow:0 1px 2px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.1);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .container{padding:24px;max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    h1{font-size:22px;margin:0;display:flex;gap:8px;align-items:center}
    .grid{display:grid;gap:24px}
    @media(min-width:1024px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-h{padding:16px 16px 8px 16px;border-bottom:1px solid var(--border)}
    .card-h .title{font-weight:700;display:flex;gap:8px;align-items:center}
    .card-h .desc{font-size:12px;color:var(--muted);margin-top:4px}
    .card-c{padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.icon{width:36px;height:36px;justify-content:center}
    .btn.sm{padding:6px 10px;font-size:12px}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;background:#fff}
    .item-c{padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .item .title{font-size:13px;font-weight:600}
    .item .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:38vw}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input, textarea, select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    textarea{min-height:70px}
    .kicker{font-size:12px;font-weight:700;margin:8px 0}
    .attendee{border:1px solid var(--border);border-radius:12px;padding:10px}
    .avatar{width:44px;height:44px;border-radius:999px;background:#eee;display:inline-flex;align-items:center;justify-content:center}
    .hour-grid{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .hour-row{display:grid;grid-template-columns:110px 1fr;border-bottom:1px solid var(--border)}
    .hour-row:last-child{border-bottom:none}
    .hour-label{padding:8px 12px;text-align:right;color:var(--muted);font-size:12px}
    .hour-cell{padding:8px 12px}
    .ghost{height:24px;border-radius:8px;background:var(--primary-50)}
    .meeting-pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .tools{display:flex;gap:8px;align-items:center}
    .tabs{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .tab{padding:6px 10px;border:0;background:#fff;cursor:pointer}
    .tab.active{background:var(--primary);color:#fff}
    .spacer{height:8px}
    .hidden{display:none}
    .hr{height:1px;background:var(--border);margin:12px 0}
    dialog{border:none;border-radius:14px;width:min(720px,96vw);} dialog::backdrop{background:rgba(0,0,0,.35)}
    .dialog-c{padding:16px} .dialog-actions{display:flex;justify-content:flex-end;gap:8px;padding:0 16px 16px}
    .link{color:var(--blue);text-decoration:underline}
    .flex{display:flex}.gap8{gap:8px}.gap12{gap:12px}.gap16{gap:16px}.col{display:flex;flex-direction:column}.wfull{width:100%}.end{justify-content:flex-end}
    .ae{border:1px solid var(--border);border-radius:12px;padding:10px}
.ae-grid{display:grid;grid-template-columns:56px 1fr;gap:12px;align-items:flex-start}
.ae-avatar{width:44px;height:44px;border-radius:999px;background:#eee;display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700}
.ae-avatar img{width:44px;height:44px;object-fit:cover;border-radius:999px}
.ae-two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ae-actions{display:flex;justify-content:flex-end;margin-top:8px}
    .ae-linkwrap{display:flex;gap:8px;align-items:center}
    .meeting-pill { /* existing */ }
.item.session{
  border-left: 4px solid var(--session-accent);
  background: #fff;}
.item.session .title{ color: var(--session-accent); }

/* Hourly pills: colored outline + subtle fill of the same hue (not pale gray) */
.meeting-pill.session{
  border: 1px solid var(--session-accent);
  background: var(--session-accent);
  color:#fff;
}
.meeting-pill.session .muted{ color: rgba(255,255,255,.8); }
    /* === Blue background + interactive polish === */
:root{
  --bg:#1d4ed8;          /* page background */
  --card:#ffffff;        /* cards/boxes stay white */
  --primary:#1d4ed8;     /* brand/accents */
  --primary-50:#eff6ff;  /* pale blue for subtle fills */
  --blue:#1d4ed8;
  --shadow-hover:0 6px 12px rgba(0,0,0,.18);
 --session-accent: #7c3aed;   
    --meeting-accent:#f59e0b; /* light orange */
  --meeting-bg:#fff7ed;     /* very light orange fill */
}

/* Agenda cards */
.item.meeting{
  border-left:4px solid var(--meeting-accent);
  background:#fff;
}
.item.meeting .title{ color:var(--meeting-accent); }

/* Hourly pills */
.meeting-pill.meeting{
  border:1px solid var(--meeting-accent);
  background:var(--meeting-bg);
}

/* Make header text readable on blue */
header h1,
header .muted { color:#fff; }
header .muted { opacity:.9; }
.head-left{ display:flex; align-items:center; gap:12px; }

/* Make the logo align well with the text */
h1{
  display:flex;
  align-items:center;
  gap:10px;
  margin:0;
}

.brand-logo{
  height:24px;     /* tweak to taste (20–28px usually looks good) */
  width:auto;
  object-fit:contain;
  border-radius:6px; /* optional */
}


/* Hover lift for cards and list items */
.card{
  transition: box-shadow .25s ease, transform .2s ease;
}
.card:hover{
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}
.item{
  transition: box-shadow .25s ease, transform .2s ease;
}
.item:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

/* Slightly brighter active tab/button on hover */
.tab.active:hover{
  filter: brightness(1.05);
}
.btn.primary{
  transition: transform .15s ease, box-shadow .2s ease, filter .15s ease;
}
.btn.primary:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
  filter: brightness(1.05);
}

/* Optional: underline links a touch darker on hover */
.link:hover { filter: brightness(.95); }
    :root{
  --bg:#19a4d0;              /* page background */
  --card:#ffffff;            /* keep cards white */
  --text:#111827;            /* keep dark text (for inside cards) */
  --border:#e5e7eb;

  --primary:#19a4d0;         /* primary brand blue */
  --primary-hover:#148fb6;   /* a bit darker for hover/focus */
  --primary-50:#e8f7fc;      /* very light tint for subtle fills */
  --blue:#19a4d0;            /* link color */
}

/* Make header text readable on the blue background */
header h1,
header .tools { color:#fff; }
header .muted { color:rgba(255,255,255,.85); }
header .tools .btn {
  color: var(--text);
  background:#fff;
  border-color: var(--border);
}
/* Optional: nicer hover for primary buttons & active tabs */
.btn.primary:hover{
  background:var(--primary-hover);
  border-color:var(--primary-hover);
}
.tab.active:hover{
  background:var(--primary-hover);
}
    .brand{display:flex;gap:10px;align-items:center}
.brand-logo{height:28px;width:auto;border-radius:6px;background:#fff;padding:2px;box-shadow:var(--shadow)}
.brand-logo.hidden{display:none}
    .head-left{
  display:flex;
  align-items:center;
  gap:12px;
}

.brand-logo{
  height:32px;   /* tweak if you want it bigger/smaller */
  width:auto;
  object-fit:contain;
  border-radius:6px; /* optional little rounding */
}
/* Compact GPT card */
#gptCard { 
  margin-bottom: 16px;            /* space before Schedule/Agenda */
}
#gptCard .card-h { 
  padding: 10px 12px;             /* tighter header */
}
#gptCard .tools .btn,
#gptCard .btn.sm {
  padding: 4px 8px;               /* smaller buttons */
  font-size: 12px;
}
#gptCard .desc { 
  margin-top: 6px; 
}

/* If you previously centered the GPT card, undo it */
#gptCard { text-align: left; }
#gptCard .card-h .title { justify-content: flex-start; }
#gptCard .tools { justify-content: flex-start; }
    #gptCard { margin-bottom: 16px; }                /* space before Schedule/Agenda */
#gptCard .card-h { padding: 10px 12px; }         /* tighten vertical padding */

#gptCard .gpt-head {
  align-items: center;
  justify-content: space-between;                /* title left, buttons right */
  gap: 12px;
}

#gptCard .title {
  font-size: 20px;                               /* bigger title */
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: .2px;
}

#gptCard .tools { display: flex; gap: 8px; }
#gptCard .btn.sm { padding: 6px 10px; font-size: 13px; }

#gptCard .desc {
  margin-top: 6px;                               /* small, consistent hint */
  font-size: 12px;
  color: var(--muted);
}

/* If you previously centered GPT content, undo it to avoid odd spacing */
#gptCard, #gptCard .card-h, #gptCard .desc { text-align: left; }
    #gptCard .tools { gap: 10px; }

#gptCard .btn.sm {
  min-height: 40px;      /* taller button */
  padding: 8px 14px;     /* more breathing room */
  font-size: 14px;       /* slightly larger text */
  border-radius: 12px;   /* a touch more rounded */
}
  </style>

  <!-- Firebase compat SDKs (no build step) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyAefJL7N3PBdQeGJWwjJZjfEQC8qUcpT5U",
    authDomain: "tradeshow-assistant.firebaseapp.com",
    projectId: "tradeshow-assistant",
    storageBucket: "tradeshow-assistant.firebasestorage.app",
    messagingSenderId: "865900601935",
    appId: "1:865900601935:web:82a7b49e70f8088d40003a"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const db = firebase.firestore();
  const COL = db.collection('tradeshow');

  async function getSharedDoc(docId, fallback) {
    const snap = await COL.doc(docId).get();
    return snap.exists ? snap.data().value : fallback;
  }
  async function setSharedDoc(docId, value) {
    return COL.doc(docId).set({ value }, { merge: true });
  }
  function onSharedDoc(docId, cb) {
    return COL.doc(docId).onSnapshot(s => { if (s.exists) cb(s.data().value); });
  
  
}

</script>
</head>
<body>
  <div class="container">
  <header>
  <div class="head-left">
    <h1>
      <!-- Logo replaces the emoji -->
      <img id="brandLogo" class="brand-logo hidden" alt="Company logo" />
        <button id="setLogoBtn" class="btn sm" type="button">🖼️ Set logo</button>
      <input id="logoFile" type="file" accept="image/*" class="hidden" />
  Your Inbound 2025 Assistant
  <span class="muted" style="font-weight:400"></span>
</h1>
      
  </div>
  <div class="tools">
    <div id="importExport"></div>
  </div>
</header>
<div id="gptCard" class="card">
  <div class="card-h">
    <div class="row gpt-head">
      <div class="title">🔗 Ask our GPT</div>
      <div class="tools">
        <a id="openGpt" class="btn sm" href="#" target="_blank" rel="noreferrer">Open GPT</a>
        <button id="setGptBtn" class="btn sm">⚙️ Set Link</button>
        
      </div>
    </div>
    <div id="gptHint" class="desc">No link set yet. Click <em>Set Link</em> to add one.</div>
  </div>
</div>

    <div class="grid">
      <!-- Left -->
      <div class="col gap16">
        <div class="card">
          <div class="card-h">
            <div class="title">📆 Schedule</div>
            <div class="desc">Switch between an agenda and an hourly grid for any show day.</div>
          </div>
          <div class="card-c">
            <div class="row">
              <div class="tools">
                <button class="btn icon" id="prevDay" title="Previous day">◀</button>
                <div id="activeDateLbl" style="font-weight:600"></div>
                <button class="btn icon" id="nextDay" title="Next day">▶</button>
              </div>
              <div class="tabs">
                <button class="tab active" id="tabAgenda">Agenda</button>
                <button class="tab" id="tabHourly">Hourly</button>
              </div>
            </div>

            <div id="agendaList" class="list" style="margin-top:12px"></div>
            <div id="hourlyGrid" class="hidden" style="margin-top:12px"></div>

            <div class="spacer"></div>
            <button id="addMeetingBtn" class="btn primary wfull">➕ Add meeting</button>
          </div>
        </div>

        <!-- Ask our GPT -->
        

        <!-- Travel -->
        <div class="card">
          <div class="card-h">
            <div class="title">✈️ Travel</div>
            <div class="desc">Store flight, hotel, and ground confirmations.</div>
          </div>
          <div class="card-c" id="travelSection"></div>
        </div>
      </div>

      <!-- Right -->
      <div class="col gap16" id="detailsCol"></div>
    </div>
  </div>
<dialog id="meetingDialog">
  <div class="dialog-c">
    <h3 id="dlgTitle" style="margin:0 0 8px 0">New meeting</h3>
    <div class="col gap12">
      <input id="m_title" placeholder="Title" />
      <div class="two">
        <input id="m_location" placeholder="Location" />
        <input id="m_booth" placeholder="Booth" />
      </div>
      <div class="two">
        <input id="m_start" type="datetime-local" />
        <input id="m_end" type="datetime-local" />
      </div>
      <textarea id="m_desc" placeholder="Description / goals"></textarea>

      <div class="kicker">Attendees</div>
      <div id="attendeeEditor" class="col gap12"></div>
      <div class="ae-actions">
        <button type="button" class="btn sm" id="addAttendeeBtn">➕ Add attendee</button>
      </div>
    </div>
  </div>
  <div class="dialog-actions">
    <button class="btn" id="dlgCancel">Cancel</button>
    <button class="btn primary" id="dlgSave">Save</button>
  </div>
</dialog>


  <dialog id="gptDialog">
    <div class="dialog-c">
      <h3 style="margin:0 0 8px 0">Set your GPT link</h3>
      <div class="col gap12">
        <input id="gptInput" placeholder="https://chat.openai.com/g/g-XXXXX-your-gpt"/>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="gptCancel">Cancel</button>
      <button class="btn primary" id="gptSave">Save</button>
    </div>
  </dialog>

  <dialog id="travelDialog">
    <div class="dialog-c">
      <h3 style="margin:0 0 8px 0">New travel</h3>
      <div class="col gap12">
        <div class="two">
          <select id="t_type">
            <option value="flight">Flight</option>
            <option value="hotel">Hotel</option>
            <option value="ground">Ground</option>
          </select>
          <input id="t_label" placeholder="Label (e.g., ATL → BOS)" />
        </div>
        <div class="two">
          <input id="t_conf" placeholder="Confirmation #" />
          <input id="t_details" placeholder="Details" />
        </div>
        <div class="two">
          <input id="t_start" type="datetime-local" />
          <input id="t_end" type="datetime-local" />
        </div>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="t_cancel">Cancel</button>
      <button class="btn primary" id="t_save">Save</button>
    </div>
  </dialog>

  <script>
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const uid = () => Math.random().toString(36).slice(2,9);
    const TZ = 'America/Los_Angeles';  
   const fmtTime = (iso) =>
  new Date(iso).toLocaleTimeString([], {
    hour: "2-digit", minute: "2-digit", timeZone: TZ
  });

const fmtDate = (iso) =>
  new Date(iso).toLocaleDateString([], {
    year: "numeric", month: "short", day: "2-digit", timeZone: TZ
  });
  const hoursBetween = (startISO, endISO) =>
  (new Date(endISO).getTime() - new Date(startISO).getTime()) / (1000 * 60 * 60);
    const ptMinutes = (iso) => {
  const parts = new Intl.DateTimeFormat('en-US', {
    timeZone: TZ, hour:'2-digit', minute:'2-digit', hour12:false
  }).formatToParts(new Date(iso));
  const h = +parts.find(p=>p.type==='hour').value;
  const m = +parts.find(p=>p.type==='minute').value;
  return h*60 + m;
};
   const sameDay = (aISO, bISO) => {
  const parts = iso => new Intl.DateTimeFormat('en-CA', {
    timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit'
  }).formatToParts(new Date(iso))
    .reduce((o,p)=> (p.type!=='literal' && (o[p.type]=p.value), o), {});
  const A = parts(aISO), B = parts(bISO);
  return A.year===B.year && A.month===B.month && A.day===B.day;
};
function isoToInputInTZ(iso, timeZone) {
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone, hour12:false,
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit'
  }).formatToParts(new Date(iso))
    .reduce((o,p)=> (p.type!=='literal' && (o[p.type]=p.value), o), {});
  return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}`;
}

function wallToIsoInTZ(inputStr, timeZone) {
  const [y,m,dH] = inputStr.split('-');
  const [d, hm]  = dH.split('T');
  const [H, M]   = hm.split(':');
  let utcMs = Date.UTC(+y, +m-1, +d, +H, +M, 0);

  const offsetAt = (ms) => {
    const date = new Date(ms);
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone, hour12:false,
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    }).formatToParts(date)
      .reduce((o,p)=> (p.type!=='literal' && (o[p.type]=p.value), o), {});
    const asUTC = Date.UTC(+parts.year, +parts.month-1, +parts.day,
                           +parts.hour, +parts.minute, +parts.second);
    return (asUTC - date.getTime()) / 60000; // minutes
  };

  const off1 = offsetAt(utcMs);
  utcMs -= off1 * 60000;
  const off2 = offsetAt(utcMs);
  if (off2 !== off1) utcMs -= (off2 - off1) * 60000;

  return new Date(utcMs).toISOString();
}
    // seed
    const seedDate = (()=>{
      const now = new Date();
      return new Date(now.getFullYear(), 8, 16, 9, 0, 0);
    })();
    const SAMPLE_ATTENDEES = [
      {id:uid(), name:"Chris Williams", title:"VP Partnerships", company:"NorthBridge", linkedin:"", photoUrl:"", notes:"Loves concise dashboards; ask about Zoho practice."},
      {id:uid(), name:"Amanda Lee", title:"Head of Marketing", company:"Protocol80", linkedin:"", photoUrl:"", notes:"Interested in co-marketing webinars and case studies."},
      {id:uid(), name:"Hudson Carter", title:"Solutions Architect", company:"CloudTrailz", linkedin:"", photoUrl:"", notes:"Deep NetSuite background; prefers technical prep notes."},
    ];
    const SAMPLE_MEETINGS = [
      { id:uid(), title:"NorthBridge + Commercient intro", description:"Explore reseller fit; prioritize Zoho + Monday integrations.",
        location:"Hall B – Meeting Room 3", booth:"B122",
        startISO:new Date(seedDate.getTime()).toISOString(),
        endISO:new Date(seedDate.getTime()+60*60*1000).toISOString(),
        attendees:[SAMPLE_ATTENDEES[0]], talkingPoints:"15% target share…", prepChecklist:"Review Zoho…"},
      { id:uid(), title:"Protocol80 co-marketing sprint", description:"Finalize webinar topics and case study pipeline.",
        location:"Expo Café (near Hall A)", booth:"A210",
        startISO:new Date(seedDate.getTime()+2*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()+3*60*60*1000).toISOString(),
        attendees:[SAMPLE_ATTENDEES[1]], talkingPoints:"Partner Spotlight…", prepChecklist:"Bring sample…"},
      { id:uid(), title:"CloudTrailz technical sync", description:"Deep-dive NetSuite<->HubSpot patterns; managed custom objects beta lessons.",
        location:"Booth C341", booth:"C341",
        startISO:new Date(seedDate.getTime()+4*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()+5*60*60*1000).toISOString(),
        attendees:[SAMPLE_ATTENDEES[2]], talkingPoints:"QuickBooks Desktop…", prepChecklist:"Open architecture…"},
    ];
    const SAMPLE_TRAVEL = [
      {id:uid(), type:"flight", label:"ATL → BOS (AC 1234)", confirmation:"Z7X9QW",
        startISO:new Date(seedDate.getTime()-24*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()-22*60*60*1000).toISOString(), details:"Seat 14C; carry-on only."},
      {id:uid(), type:"hotel", label:"Westin Seaport, Boston", confirmation:"H987654",
        startISO:new Date(seedDate.getTime()-1*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()+2*24*60*60*1000).toISOString(), details:"Reservation under Commercient; breakfast included."},
    ];
const MEETINGS = COL.doc('meetings').collection('items');
const TRAVEL   = COL.doc('travel').collection('items');

function upsertMeeting(m){
  const id = m.id || uid();
  return MEETINGS.doc(id).set({ ...m, id }, { merge: true });
}
function deleteMeeting(id){ return MEETINGS.doc(id).delete(); }

function upsertTravel(t){
  const id = t.id || uid();
  return TRAVEL.doc(id).set({ ...t, id }, { merge: true });
}
function deleteTravel(id){ return TRAVEL.doc(id).delete(); }
    // state (will be replaced by Firestore values on load)
    let meetings = structuredClone(SAMPLE_MEETINGS);
    let travel   = structuredClone(SAMPLE_TRAVEL);
    let gptUrl   = "";
let logoUrl = "";
    let activeDate = (meetings[0]?.startISO) || new Date().toISOString();
    let view = "agenda";

    // elements
    const activeDateLbl = $("#activeDateLbl");
    const prevDayBtn = $("#prevDay");
    const nextDayBtn = $("#nextDay");
    const tabAgenda = $("#tabAgenda");
    const tabHourly = $("#tabHourly");
    const agendaList = $("#agendaList");
    const hourlyGrid = $("#hourlyGrid");
    const addMeetingBtn = $("#addMeetingBtn");
    const detailsCol = $("#detailsCol");
    const openGptA = $("#openGpt");
    const setGptBtn = $("#setGptBtn");
    const gptHint = $("#gptHint");
    const travelSection = $("#travelSection");
    const brandLogo  = $("#brandLogo");
const setLogoBtn = $("#setLogoBtn");

const logoFile  = $("#logoFile");

    // dialogs
    const meetingDialog = $("#meetingDialog");
    const dlgSave = $("#dlgSave");
    const dlgCancel = $("#dlgCancel");
    const dlgTitle = $("#dlgTitle");
    const m_title = $("#m_title");
    const m_location = $("#m_location");
    const m_booth = $("#m_booth");
    const m_start = $("#m_start");
    const m_end = $("#m_end");
    const m_desc = $("#m_desc");
   
const attendeeEditorRoot = $("#attendeeEditor");
const addAttendeeBtn = $("#addAttendeeBtn");
let currentAttendees = [];

const blankAttendee = () => ({
  id: uid(), name:"", title:"", company:"", linkedin:"", photoUrl:"", notes:""
});
function sanitizeUrl(u){
  if(!u) return "";
  let s = u.trim();
  if (!/^https?:\/\//i.test(s)) s = "https://" + s;
  return s;
}


function buildAttendeeRow(a){
  const wrap = document.createElement("div");
  wrap.className = "ae";
  wrap.dataset.id = a.id;

  const grid = document.createElement("div");
  grid.className = "ae-grid";

  // Avatar
  const avatar = document.createElement("div");
  avatar.className = "ae-avatar";
  if (a.photoUrl) {
    const img = document.createElement("img");
    img.src = a.photoUrl;
    avatar.append(img);
  } else {
    avatar.textContent = (a.name || "?").slice(0,1).toUpperCase();
  }

  // Right side
  const right = document.createElement("div");
  right.className = "col gap8";

  // Row 1: name + title
  const row1 = document.createElement("div"); row1.className = "ae-two";
  const inName  = document.createElement("input"); inName.placeholder  = "Full name"; inName.value  = a.name  || "";
  const inTitle = document.createElement("input"); inTitle.placeholder = "Job title"; inTitle.value = a.title || "";
  row1.append(inName, inTitle);

  // Row 2: company + LinkedIn
  const row2 = document.createElement("div"); row2.className = "ae-two";
  const inCompany = document.createElement("input"); inCompany.placeholder = "Company"; inCompany.value = a.company || "";

  const linkWrap = document.createElement("div"); linkWrap.className = "ae-linkwrap";
  const inLinkedin = document.createElement("input");
  inLinkedin.placeholder = "LinkedIn URL (https://…)";
  inLinkedin.value = a.linkedin || "";
  const btnOpen = document.createElement("button");
  btnOpen.className = "btn sm"; btnOpen.type = "button"; btnOpen.textContent = "🔗 Open";
  btnOpen.disabled = !inLinkedin.value.trim();
  btnOpen.onclick = () => {
    const url = sanitizeUrl(inLinkedin.value);
    if (url) window.open(url, "_blank", "noopener,noreferrer");
  };
  inLinkedin.addEventListener("input", () => { btnOpen.disabled = !inLinkedin.value.trim(); });
  linkWrap.append(inLinkedin, btnOpen);
  row2.append(inCompany, linkWrap);

  // Photo URL + Upload
  const inPhoto = document.createElement("input");
  inPhoto.placeholder = "Photo URL or data URL";
  inPhoto.value = a.photoUrl || "";

  const upBtn = document.createElement("button");
  upBtn.className = "btn sm"; upBtn.type = "button"; upBtn.textContent = "📷 Upload";

  const inFile = document.createElement("input");
  inFile.type = "file"; inFile.accept = "image/*"; inFile.className = "hidden";

  upBtn.onclick = () => inFile.click();
  inFile.onchange = async (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    try {
      const dataUrl = await fileToDataUrl(file, { maxW:256, maxH:256, quality:0.9 });
      inPhoto.value = dataUrl; a.photoUrl = dataUrl;
      avatar.innerHTML = ""; const img2 = document.createElement("img"); img2.src = dataUrl; avatar.append(img2);
    } catch (err) { console.error(err); alert("Could not read that image. Try a PNG or JPG."); }
    finally { inFile.value = ""; }
  };

  inPhoto.addEventListener("input", () => {
    a.photoUrl = inPhoto.value.trim();
    avatar.innerHTML = "";
    if (a.photoUrl){
      const img2 = document.createElement("img"); img2.src = a.photoUrl; avatar.append(img2);
    } else {
      avatar.textContent = (inName.value || "?").slice(0,1).toUpperCase();
    }
  });

  const photoWrap = document.createElement("div");
  photoWrap.className = "ae-linkwrap";
  photoWrap.append(inPhoto, upBtn, inFile);

  // Notes
  const inNotes = document.createElement("textarea");
  inNotes.placeholder = "Notes";
  inNotes.value = a.notes || "";

  // Remove
  const actions = document.createElement("div"); actions.className = "ae-actions";
  const btnRemove = document.createElement("button"); btnRemove.className = "btn sm"; btnRemove.textContent = "🗑️ Remove";
  btnRemove.onclick = () => {
    currentAttendees = currentAttendees.filter(x => x.id !== a.id);
    renderAttendeeEditor(currentAttendees);
  };
  actions.append(btnRemove);

  right.append(row1, row2, photoWrap, inNotes);
  grid.append(avatar, right);
  wrap.append(grid, actions);
  return wrap;
}

function renderAttendeeEditor(list){
  attendeeEditorRoot.innerHTML = "";
  if (!list || list.length === 0){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "No attendees yet.";
    attendeeEditorRoot.append(empty);
    return;
  }
  list.forEach(a => attendeeEditorRoot.append(buildAttendeeRow(a)));
}

function collectAttendeesFromEditor(){
  const rows = Array.from(attendeeEditorRoot.querySelectorAll(".ae"));
  return rows.map(row => {
    const q = (sel) => row.querySelector(sel);
    return {
      id: row.dataset.id,
      name:      (q('input[placeholder="Full name"]')?.value || "").trim(),
      title:     (q('input[placeholder="Job title"]')?.value || "").trim(),
      company:   (q('input[placeholder="Company"]')?.value || "").trim(),
      linkedin:  (q('input[placeholder^="LinkedIn URL"]')?.value || "").trim(),
      photoUrl:  (q('input[placeholder^="Photo URL"]')?.value || "").trim(),
      notes:     (q('textarea[placeholder="Notes"]')?.value || "").trim(),
    };
  });
}

    const gptDialog = $("#gptDialog");
    const gptInput = $("#gptInput");
    const gptSave = $("#gptSave");
    const gptCancel = $("#gptCancel");

    const travelDialog = $("#travelDialog");
    const t_type = $("#t_type");
    const t_label = $("#t_label");
    const t_conf = $("#t_conf");
    const t_details = $("#t_details");
    const t_start = $("#t_start");
    const t_end = $("#t_end");
    const t_save = $("#t_save");
    const t_cancel = $("#t_cancel");

 function daysFromMeetings(list){
  const fmt = new Intl.DateTimeFormat('en-CA', {
    timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit'
  });
  const byDay = new Map(); // key = 'YYYY-MM-DD' in PT -> earliest ISO on that day
  list.forEach(m => {
    const k = fmt.format(new Date(m.startISO));
    const cur = byDay.get(k);
    if (!cur || new Date(m.startISO) < new Date(cur)) byDay.set(k, m.startISO);
  });
  return Array.from(byDay.values()).sort((a,b)=> new Date(a) - new Date(b)); // ISO strings
}
    function shiftDay(dir){
  const days = daysFromMeetings(meetings);
  const idx = days.findIndex(d => sameDay(d, activeDate)); // both ISO strings
  const next = days[idx + dir];
  if (next) activeDate = next;
  renderAll();
}
    function renderHeaderControls(){
      activeDateLbl.textContent = fmtDate(activeDate);
      tabAgenda.classList.toggle("active", view==="agenda");
      tabHourly.classList.toggle("active", view==="hourly");
    }
const SESSIONS = COL.doc('sessions').collection('items');

// Helpers
function upsertSession(s){
  const id = s.id || uid();
  return SESSIONS.doc(id).set({ ...s, id }, { merge:true });
}
function deleteSession(id){ return SESSIONS.doc(id).delete(); }

// State
let sessions = [];

try {
  SESSIONS.orderBy('startISO').onSnapshot(
    snap => {
      sessions = snap.docs.map(d => d.data());
      renderAll(); // update agenda/hourly with sessions if any
    },
    err => {
      console.warn('SESSIONS listener error:', err);
      sessions = []; // keep UI alive even if Firestore blocks
      renderAll();
    }
  );
} catch (e) {
  console.warn('SESSIONS subscribe failed:', e);
  sessions = [];
  renderAll();
}
  function itemsForDay(iso){
  const m = meetings
    .filter(x => sameDay(x.startISO, iso))
    .map(x => ({ ...x, kind: 'meeting' }));

  const s = sessions
    .filter(x => sameDay(x.startISO, iso))
    .map(x => ({ ...x, kind: 'session' }));

  return [...m, ...s].sort((a,b)=> new Date(a.startISO) - new Date(b.startISO));
}
 function renderAgenda(){
  agendaList.innerHTML = "";
  const items = itemsForDay(activeDate);
  if(items.length === 0){
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = "No items for this date.";
    agendaList.append(div);
    return;
  }

  items.forEach(it => {
    const card = document.createElement("div");
    card.className = "item";
    card.classList.add(it.kind); // 'meeting' or 'session'

    const c = document.createElement("div");
    c.className = "item-c";

    const left = document.createElement("div");
    const title = document.createElement("div");
    title.className = "title";

    const where = it.location || it.stage || it.room || "";
    const main = `${fmtTime(it.startISO)}–${fmtTime(it.endISO)} • ${it.title}`;
    title.textContent = (it.kind === 'session' && where) ? `${main} — ${where}` : main;

    const sub = document.createElement("div");
    sub.className = "sub";
    sub.textContent = `${(it.kind==='meeting' ? (it.location||"") : "")}${it.booth ? ` • Booth ${it.booth}` : ""}`;
    left.append(title, sub);

    const tools = document.createElement("div");
    tools.className = "tools";

    if (it.kind === 'meeting') {
      const edit = document.createElement("button");
      edit.className = "btn sm"; edit.textContent = "✏️";
      edit.onclick = () => openMeetingDialog(it);

      const del = document.createElement("button");
      del.className = "btn sm"; del.textContent = "🗑️";
      del.onclick = async () => {
        if (!confirm("Delete this meeting?")) return;
        try { await deleteMeeting(it.id); } catch(e){ console.error(e); alert("Delete failed."); }
      };

      tools.append(edit, del);
    } else {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = "SESSION";
      tools.append(chip);
    }

    c.append(left, tools);
    card.append(c);
    agendaList.append(card);
  });
}
function renderHourly(){
  hourlyGrid.innerHTML = "";
  const items = itemsForDay(activeDate);       // PT-aware list

  const wrap = document.createElement("div");
  wrap.className = "hour-grid";

  const startHour = 7;        // 7 AM PT
  const hoursToShow = 13;     // 7am–8pm PT

  for (let i = 0; i < hoursToShow; i++){
    const hr = startHour + i;

    const row = document.createElement("div");
    row.className = "hour-row";

    // Label strictly in PT, no Date conversions
    const lbl = document.createElement("div");
    lbl.className = "hour-label";
    const h12 = ((hr + 11) % 12) + 1;
    lbl.textContent = `${h12}:00 ${hr >= 12 ? "PM" : "AM"}`;

    const cell = document.createElement("div");
    cell.className = "hour-cell";

    const hourStartMin = hr * 60;
    const hourEndMin   = hourStartMin + 60;

    // Use PT minutes for overlap
    const slot = items.filter(it => {
      const s = ptMinutes(it.startISO);
      const e = ptMinutes(it.endISO);
      return s < hourEndMin && e > hourStartMin;
    });

    if (slot.length === 0){
      const g = document.createElement("div");
      g.className = "ghost";
      cell.append(g);
    } else {
      const box = document.createElement("div");
      box.style.display="flex";
      box.style.flexWrap="wrap";
      box.style.gap="8px";
      slot.forEach(it => {
        const pill = document.createElement("span");
        pill.className = "meeting-pill";
        if (it.kind === 'session') pill.classList.add('session');
        else pill.classList.add('meeting');
        pill.innerHTML = `<strong>${it.title}</strong> <span class="muted">${fmtTime(it.startISO)}–${fmtTime(it.endISO)}</span>`;
        box.append(pill);
      });
      cell.append(box);
    }

    row.append(lbl, cell);
    wrap.append(row);
  }

  hourlyGrid.append(wrap);
}
    function renderDetails(){
      detailsCol.innerHTML = "";
      const dayMeetings = meetings
        .filter(m => sameDay(m.startISO, activeDate))
        .sort((a,b)=> new Date(a.startISO)-new Date(b.startISO));

      if(dayMeetings.length===0){
        const card = document.createElement("div"); card.className="card";
        card.innerHTML = `<div class="card-h"><div class="title">No meetings this day</div></div>
                          <div class="card-c muted">Add one using the button on the left.</div>`;
        detailsCol.append(card);
        return;
      }

      dayMeetings.forEach(m => {
        const card = document.createElement("div"); card.className="card";
        const head = document.createElement("div"); head.className="card-h";
        const t = document.createElement("div"); t.className="title row";
        const left = document.createElement("span"); left.textContent = m.title;
        const right = document.createElement("span"); right.className="muted";
        right.textContent = `${fmtDate(m.startISO)} • ${fmtTime(m.startISO)}–${fmtTime(m.endISO)}`;
        t.append(left, right);
        const desc = document.createElement("div"); desc.className="desc";
        desc.textContent = `${hoursBetween(m.startISO, m.endISO).toFixed(1)} hrs • ${m.location || ""}${m.booth?` • Booth ${m.booth}`:""}`;
        head.append(t, desc);

        const c = document.createElement("div"); c.className="card-c";
        const inner = document.createElement("div"); inner.className="grid"; inner.style.gridTemplateColumns="1fr 2fr"; inner.style.gap="16px";

        const leftCol = document.createElement("div");
        if(m.description){
          const p = document.createElement("p"); p.textContent = m.description; leftCol.append(p);
        }
        if(m.talkingPoints){
          const k = document.createElement("div"); k.className="kicker"; k.textContent = "Suggested talking points";
          const box = document.createElement("div"); box.style.background="var(--primary-50)"; box.style.borderRadius="12px"; box.style.padding="12px";
          box.textContent = m.talkingPoints; leftCol.append(k, box);
        }
        if(m.prepChecklist){
          const k = document.createElement("div"); k.className="kicker"; k.textContent = "Prep checklist";
          const box = document.createElement("div"); box.style.background="var(--primary-50)"; box.style.borderRadius="12px"; box.style.padding="12px";
          box.textContent = m.prepChecklist; leftCol.append(k, box);
        }
        const edit = document.createElement("button"); edit.className="btn"; edit.textContent="✏️ Edit details";
        edit.onclick = ()=> openMeetingDialog(m);
        leftCol.append(edit);

        const rightCol = document.createElement("div");
        const ak = document.createElement("div"); ak.className="kicker"; ak.textContent="Attendees";
        rightCol.append(ak);
        (m.attendees||[]).forEach(a => {
          const wrap = document.createElement("div"); wrap.className="attendee";
          const row = document.createElement("div"); row.className="row";
          const who = document.createElement("div"); who.className="row"; who.style.gap="12px";
          const av = document.createElement("div"); av.className="avatar"; av.textContent = (a.name||"?").slice(0,1).toUpperCase();
          const meta = document.createElement("div");
          const nm = document.createElement("div"); nm.style.fontWeight="600"; nm.textContent=a.name;
          const sub = document.createElement("div"); sub.className="muted"; sub.style.fontSize="12px";
          sub.textContent=[a.title,a.company].filter(Boolean).join(" • ");
          meta.append(nm, sub);
          who.append(av, meta);
          const link = document.createElement("a"); link.className="link"; link.textContent="LinkedIn"; link.target="_blank"; link.rel="noreferrer";
          if(a.linkedin) link.href=a.linkedin; else { link.href="#"; link.style.pointerEvents="none"; link.style.opacity=".5"; }
          row.append(who, link);
          if(a.notes){ const notes=document.createElement("div"); notes.style.marginTop="6px"; notes.textContent=a.notes; wrap.append(row, notes); }
          else wrap.append(row);
          rightCol.append(wrap);
        });

      inner.append(rightCol, leftCol);
        c.append(inner);
        card.append(head, c);
        detailsCol.append(card);
      });
    }

    function renderTravel(){
      const root = travelSection;
      root.innerHTML = "";
      const add = document.createElement("button"); add.className="btn"; add.textContent="➕ Add travel";
      add.onclick = ()=>{
        t_type.value="flight"; t_label.value=""; t_conf.value=""; t_details.value="";
        t_start.value=""; t_end.value="";
        travelDialog.dataset.editId = ""; travelDialog.showModal();
      };
      root.append(add);
      const spacer = document.createElement("div");
spacer.className = "spacer";
root.append(spacer);

      if(travel.length===0){
        const div = document.createElement("div"); div.className="muted"; div.textContent="No travel saved.";
        root.append(div); return;
      }

      travel.forEach(t => {
        const row = document.createElement("div");
        row.className="item"; const inner=document.createElement("div"); inner.className="item-c";
        const left = document.createElement("div");
        const head = document.createElement("div"); head.className="title"; head.textContent = `[${t.type.toUpperCase()}] ${t.label}`;
        const sub = document.createElement("div"); sub.className="muted"; sub.style.fontSize="12px";
        const bits=[];
        if(t.confirmation) bits.push(`Conf#: ${t.confirmation}`);
        if(t.startISO) bits.push(`Start ${fmtDate(t.startISO)} ${fmtTime(t.startISO)}`);
        if(t.endISO) bits.push(`End ${fmtDate(t.endISO)} ${fmtTime(t.endISO)}`);
        sub.textContent = bits.join(" • ");
        if(t.details){ const d=document.createElement("div"); d.style.fontSize="12px"; d.textContent=t.details; left.append(head, sub, d); }
        else left.append(head, sub);
        const tools = document.createElement("div"); tools.className="tools";
        const edit = document.createElement("button"); edit.className="btn sm"; edit.textContent="✏️";
        edit.onclick = ()=>{
          t_type.value=t.type; t_label.value=t.label; t_conf.value=t.confirmation||""; t_details.value=t.details||"";
       t_start.value = t.startISO ? isoToInputInTZ(t.startISO, TZ) : "";
t_end.value   = t.endISO   ? isoToInputInTZ(t.endISO,   TZ) : "";
          travelDialog.dataset.editId = t.id; travelDialog.showModal();
        };
        const del = document.createElement("button"); del.className="btn sm"; del.textContent="🗑️";
   del.onclick = async () => {
  if (!confirm("Delete this travel item?")) return;
  try { await deleteTravel(t.id); }
  catch(e){ console.error(e); alert("Delete failed."); }
};
        tools.append(edit, del);
        inner.append(left, tools);
        row.append(inner);
        root.append(row);
      });
    }

  function openMeetingDialog(m){
  meetingDialog.dataset.editId = m?.id || "";
  dlgTitle.textContent = m ? "Edit meeting" : "New meeting";
  m_title.value = m?.title || "";
    m_location.value = m?.location || "";
m_booth.value    = m?.booth || "";
    m_desc.value = m?.description || ""; 
 

 m_start.value = isoToInputInTZ(m ? m.startISO : new Date().toISOString(), TZ);
  m_end.value   = isoToInputInTZ(m ? m.endISO   : new Date(Date.now()+60*60*1000).toISOString(), TZ);

  // Load attendees into editor
  currentAttendees = Array.isArray(m?.attendees) ? structuredClone(m.attendees) : [];
  renderAttendeeEditor(currentAttendees);

  // Add attendee button
  addAttendeeBtn.onclick = () => {
    currentAttendees = [...currentAttendees, blankAttendee()];
    renderAttendeeEditor(currentAttendees);
  };

  meetingDialog.showModal();
}
async function saveMeetingFromDialog(){
  const id = meetingDialog.dataset.editId;
  const payload = {
    id: id || uid(),
    title: m_title.value.trim(),
    location: m_location.value.trim(),
    booth: m_booth.value.trim(),
 startISO: wallToIsoInTZ(m_start.value, TZ),
  endISO:   wallToIsoInTZ(m_end.value,   TZ),
    attendees: collectAttendeesFromEditor(),
    description: m_desc.value.trim(),
  };
  if (!payload.title){ alert("Title required"); return; }
  if (new Date(payload.endISO) <= new Date(payload.startISO)){
    alert("End time must be after start time."); return;
  }

   try {
    await upsertMeeting(payload);   // <-- write to subcollection
    meetingDialog.close();
  } catch (e){
    console.error(e);
    alert('Cloud save failed.');
  }
}

    function renderGpt(){
      if(gptUrl){
        openGptA.href = gptUrl;
        openGptA.removeAttribute('disabled');
        gptHint.style.display = "none";
      }else{
        openGptA.href="#";
        gptHint.style.display = "block";
      }
    }
function renderLogo(){
  // If there's no saved URL: hide image, show the button, and bail.
  if (!logoUrl) {
    brandLogo.removeAttribute('src');
    brandLogo.classList.add('hidden');
    setLogoBtn.classList.remove('hidden');
    return;
  }

  // Verify the URL loads before we hide the button.
  const probe = new Image();
  probe.onload = () => {
    brandLogo.src = logoUrl;
    brandLogo.classList.remove('hidden');
    setLogoBtn.classList.add('hidden');  // hide only after a successful load
  };
  probe.onerror = async () => {
    // Bad URL: clear it so the button comes back.
    brandLogo.removeAttribute('src');
    brandLogo.classList.add('hidden');
    setLogoBtn.classList.remove('hidden');
    logoUrl = '';
    await setSharedDoc('logoUrl', '');
  };
  probe.src = logoUrl;
}

async function renderImportExport(){
  const root = document.createElement("div");
  const inp = document.createElement("input");
  inp.type = "file"; inp.accept = "application/json"; inp.className = "hidden";

  const btnImport = document.createElement("button"); 
  btnImport.className = "btn sm"; 
  btnImport.textContent = "⬆️ Import";

  const btnExport = document.createElement("button"); 
  btnExport.className = "btn sm"; 
  btnExport.textContent = "⬇️ Export";

  btnImport.onclick = () => inp.click();

  // IMPORT
  inp.onchange = async (e) => {
    const f = e.target.files?.[0]; 
    if (!f) return;
    try {
      const parsed = JSON.parse(await f.text());

      // Replace ALL meetings
      const ms = await MEETINGS.get();
      let batch = db.batch();
      ms.forEach(doc => batch.delete(doc.ref));
      (parsed.meetings || []).forEach(m => {
        const id = m.id || uid();
        batch.set(MEETINGS.doc(id), { ...m, id });
      });
      await batch.commit();

      // Replace ALL travel
      const ts = await TRAVEL.get();
      batch = db.batch();
      ts.forEach(doc => batch.delete(doc.ref));
      (parsed.travel || []).forEach(t => {
        const id = t.id || uid();
        batch.set(TRAVEL.doc(id), { ...t, id });
      });
      await batch.commit();

      // Replace ALL sessions (NEW)
      if (Array.isArray(parsed.sessions)) {
        const ss = await SESSIONS.get();
        batch = db.batch();
        ss.forEach(doc => batch.delete(doc.ref));
        (parsed.sessions || []).forEach(s => {
          const id = s.id || uid();
          batch.set(SESSIONS.doc(id), { ...s, id });
        });
        await batch.commit();
      }

      if ('gptUrl' in parsed)  await setSharedDoc('gptUrl',  parsed.gptUrl  || '');
      if ('logoUrl' in parsed) await setSharedDoc('logoUrl', parsed.logoUrl || '');
    } catch(err){
      console.error(err);
      alert("Invalid JSON file");
    } finally {
      inp.value = '';
    }
  };

  // EXPORT
  btnExport.onclick = async () => {
    const [msSnap, tsSnap, ssSnap] = await Promise.all([
      MEETINGS.get(),
      TRAVEL.get(),
      SESSIONS.get()
    ]);
    const file = {
      meetings: msSnap.docs.map(d => d.data()),
      travel:   tsSnap.docs.map(d => d.data()),
      sessions: ssSnap.docs.map(d => d.data()),
      gptUrl,
      logoUrl
    };
    const blob = new Blob([JSON.stringify(file, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `tradeshow-data-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  root.append(btnImport, btnExport, inp);
  $("#importExport").innerHTML = "";
  $("#importExport").append(root);
}
    // event wiring
    prevDayBtn.onclick = ()=> shiftDay(-1);
    nextDayBtn.onclick = ()=> shiftDay(1);
    tabAgenda.onclick = ()=>{ view="agenda"; renderAll(); };
    tabHourly.onclick = ()=>{ view="hourly"; renderAll(); };
    addMeetingBtn.onclick = ()=> openMeetingDialog();
    dlgCancel.onclick = ()=> meetingDialog.close();
    dlgSave.onclick = ()=> saveMeetingFromDialog();

    setGptBtn.onclick = ()=>{ gptInput.value = gptUrl || ""; gptDialog.showModal(); };
    gptCancel.onclick = ()=> gptDialog.close();
    gptSave.onclick = async ()=>{ gptUrl = (gptInput.value||"").trim(); await setSharedDoc('gptUrl', gptUrl); gptDialog.close(); };

    t_cancel.onclick = ()=> travelDialog.close();
t_save.onclick = async () => {
  const id = travelDialog.dataset.editId;
  const payload = {
    id: id || uid(),
    type: t_type.value,
    label: t_label.value.trim(),
    confirmation: t_conf.value.trim(),
    details: t_details.value.trim(),
  };
if (t_start.value) payload.startISO = wallToIsoInTZ(t_start.value, TZ);
if (t_end.value)   payload.endISO   = wallToIsoInTZ(t_end.value,   TZ);
  if (!payload.label){ alert("Label required"); return; }

  if (payload.startISO && payload.endISO && new Date(payload.endISO) < new Date(payload.startISO)){
    alert("Travel end must be after start."); return;
  }

  try {
    await upsertTravel(payload);
    travelDialog.close();
  } catch(e){
    console.error(e);
    alert('Save failed.');
  }
};
setLogoBtn.addEventListener('click', () => {
  logoFile.click();
});

// When a file is chosen, read/resize to data URL and save to Firestore
logoFile.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  try {
    const dataUrl = await fileToDataUrl(file, {
      maxW: 360,     // cap width so the data URL stays small
      maxH: 120,     // header-height friendly
      quality: 0.9   // jpeg quality if we encode to jpeg
    });

    await setSharedDoc('logoUrl', dataUrl); // triggers onSnapshot -> renderLogo()
  } catch (err) {
    console.error(err);
    alert('Could not read that image. Try a PNG or JPG.');
  } finally {
    // Reset the input so picking the same file again still fires 'change'
    logoFile.value = '';
  }
});

// Utility: read & (optionally) resize the image to a data URL
function fileToDataUrl(file, { maxW = 360, maxH = 120, quality = 0.9 } = {}) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error('File read failed'));
    reader.onload = () => {
      const img = new Image();
      img.onerror = () => reject(new Error('Image decode failed'));
      img.onload = () => {
        // Calculate target size
        const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);

        // Draw into a canvas (resize if needed)
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        // Choose output format
        const wantPng = file.type.includes('png') || file.type.includes('svg');
        const mime = wantPng ? 'image/png' : 'image/jpeg';
        const out = canvas.toDataURL(mime, quality);

        resolve(out);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}
    function renderAll(){
      renderHeaderControls();
      (view==="agenda"? (agendaList.classList.remove("hidden"), hourlyGrid.classList.add("hidden"), renderAgenda())
                      : (hourlyGrid.classList.remove("hidden"), agendaList.classList.add("hidden"), renderHourly()));
      renderDetails();
      renderTravel();
      renderGpt();
        renderLogo();  
      
      
    }
renderAll(); 
    // INITIAL LOAD from Firestore + realtime subscriptions
    (async function init(){
  // One-time simple settings
  gptUrl  = (await getSharedDoc('gptUrl',  "")) || "";
  logoUrl = (await getSharedDoc('logoUrl', "")) || "";
  renderGpt(); renderLogo();
  renderImportExport();
      
  // Live settings
  onSharedDoc('gptUrl',  v => { gptUrl  = v || ""; renderGpt(); });
  onSharedDoc('logoUrl', v => { logoUrl = v || ""; renderLogo(); });

  // Realtime meetings (subcollection)
MEETINGS.orderBy('startISO').onSnapshot(
  async snap => {
    if (snap.empty) {
      try {
        const batch = db.batch();
        SAMPLE_MEETINGS.forEach(m => batch.set(MEETINGS.doc(m.id), m));
        await batch.commit();
      } catch (e) {
        console.warn('Seeding meetings failed:', e);
      }
      return;
    }
    meetings = snap.docs.map(d => d.data());
    if (!meetings.find(m => sameDay(m.startISO, activeDate)) && meetings.length){
      activeDate = meetings[0].startISO;
    }
    renderAll();
  },
  err => { console.warn('MEETINGS listener error:', err); renderAll(); }
);

TRAVEL.orderBy('startISO').onSnapshot(
  async snap => {
    if (snap.empty) {
      try {
        const batch = db.batch();
        SAMPLE_TRAVEL.forEach(t => batch.set(TRAVEL.doc(t.id), t));
        await batch.commit();
      } catch (e) {
        console.warn('Seeding travel failed:', e);
      }
      return;
    }
    travel = snap.docs.map(d => d.data());
    renderTravel();
  },
  err => { console.warn('TRAVEL listener error:', err); renderTravel(); }
);

  renderAll(); // first paint
})();
  </script>
</body>
</html>
