<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tradeshow Meetings Assistant — Realtime</title>
  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --border:#e5e7eb;
      --primary:#111827;
      --primary-50:#f3f4f6;
      --blue:#1d4ed8;
      --shadow:0 1px 2px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.1);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .container{padding:24px;max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    h1{font-size:22px;margin:0;display:flex;gap:8px;align-items:center}
    .grid{display:grid;gap:24px}
    @media(min-width:1024px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-h{padding:16px 16px 8px 16px;border-bottom:1px solid var(--border)}
    .card-h .title{font-weight:700;display:flex;gap:8px;align-items:center}
    .card-h .desc{font-size:12px;color:var(--muted);margin-top:4px}
    .card-c{padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.icon{width:36px;height:36px;justify-content:center}
    .btn.sm{padding:6px 10px;font-size:12px}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;background:#fff}
    .item-c{padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .item .title{font-size:13px;font-weight:600}
    .item .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:38vw}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input, textarea, select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    textarea{min-height:70px}
    .kicker{font-size:12px;font-weight:700;margin:8px 0}
    .attendee{border:1px solid var(--border);border-radius:12px;padding:10px}
    .avatar{width:44px;height:44px;border-radius:999px;background:#eee;display:inline-flex;align-items:center;justify-content:center}
    .hour-grid{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .hour-row{display:grid;grid-template-columns:110px 1fr;border-bottom:1px solid var(--border)}
    .hour-row:last-child{border-bottom:none}
    .hour-label{padding:8px 12px;text-align:right;color:var(--muted);font-size:12px}
    .hour-cell{padding:8px 12px}
    .ghost{height:24px;border-radius:8px;background:var(--primary-50)}
    .meeting-pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .tools{display:flex;gap:8px;align-items:center}
    .tabs{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .tab{padding:6px 10px;border:0;background:#fff;cursor:pointer}
    .tab.active{background:var(--primary);color:#fff}
    .spacer{height:8px}
    .hidden{display:none}
    .hr{height:1px;background:var(--border);margin:12px 0}
    dialog{border:none;border-radius:14px;width:min(720px,96vw);} dialog::backdrop{background:rgba(0,0,0,.35)}
    .dialog-c{padding:16px} .dialog-actions{display:flex;justify-content:flex-end;gap:8px;padding:0 16px 16px}
    .link{color:var(--blue);text-decoration:underline}
    .flex{display:flex}.gap8{gap:8px}.gap12{gap:12px}.gap16{gap:16px}.col{display:flex;flex-direction:column}.wfull{width:100%}.end{justify-content:flex-end}
    .ae{border:1px solid var(--border);border-radius:12px;padding:10px}
.ae-grid{display:grid;grid-template-columns:56px 1fr;gap:12px;align-items:flex-start}
.ae-avatar{width:44px;height:44px;border-radius:999px;background:#eee;display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700}
.ae-avatar img{width:44px;height:44px;object-fit:cover;border-radius:999px}
.ae-two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ae-actions{display:flex;justify-content:flex-end;margin-top:8px}
    .ae-linkwrap{display:flex;gap:8px;align-items:center}
    .meeting-pill { /* existing */ }
.item.session{
  border-left: 4px solid var(--session-accent);
  background: #fff;}
.item.session .title{ color: var(--text); }
.item.meeting{
  border-left: 4px solid var(--meeting-accent);
  background:#fff;
}
.item.meeting .title{ color: var(--text); }
/* Hourly pills: colored outline + subtle fill of the same hue (not pale gray) */
  .item.session.afterhours{
  border-left-color: var(--afterhours-accent);
}
  
.meeting-pill.session{
  border:1px solid var(--session-accent);
  background: var(--session-accent);
  color:#111827; /* black text */
}
.meeting-pill.session .muted{ color: rgba(17,24,39,.8); }

/* Meeting pills: dark orange fill, white text */
.meeting-pill.meeting{
  border:1px solid var(--meeting-accent);
  background: var(--meeting-accent);
  color:#fff;
}
.meeting-pill.meeting .muted{ color: rgba(255,255,255,.85); }
    /* === Blue background + interactive polish === */
    .meeting-pill.session.afterhours{
  border: 1px solid var(--afterhours-accent);
  background: var(--afterhours-accent);
  color: #111827;               /* readable dark text */
}
.meeting-pill.session.afterhours .muted{
  color: rgba(17,24,39,.8);
}
:root{
  --bg:#1d4ed8;          /* page background */
  --card:#ffffff;        /* cards/boxes stay white */
  --primary:#1d4ed8;     /* brand/accents */
  --primary-50:#eff6ff;  /* pale blue for subtle fills */
  --blue:#1d4ed8;
  --shadow-hover:0 6px 12px rgba(0,0,0,.18);
 
}

/* Make header text readable on blue */
header h1,
header .muted { color:#fff; }
header .muted { opacity:.9; }
.head-left{ display:flex; align-items:center; gap:12px; }

/* Make the logo align well with the text */
h1{
  display:flex;
  align-items:center;
  gap:10px;
  margin:0;
}

.brand-logo{
  height:24px;     /* tweak to taste (20–28px usually looks good) */
  width:auto;
  object-fit:contain;
  border-radius:6px; /* optional */
}


/* Hover lift for cards and list items */
.card{
  transition: box-shadow .25s ease, transform .2s ease;
}
.card:hover{
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}
.item{
  transition: box-shadow .25s ease, transform .2s ease;
}
.item:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

/* Slightly brighter active tab/button on hover */
.tab.active:hover{
  filter: brightness(1.05);
}
.btn.primary{
  transition: transform .15s ease, box-shadow .2s ease, filter .15s ease;
}
.btn.primary:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
  filter: brightness(1.05);
}

/* Optional: underline links a touch darker on hover */
.link:hover { filter: brightness(.95); }
    :root{
  --bg:#19a4d0;              /* page background */
  --card:#ffffff;            /* keep cards white */
  --text:#111827;            /* keep dark text (for inside cards) */
  --border:#e5e7eb;

  --primary:#19a4d0;         /* primary brand blue */
  --primary-hover:#148fb6;   /* a bit darker for hover/focus */
  --primary-50:#e8f7fc;      /* very light tint for subtle fills */
  --blue:#19a4d0;            /* link color */
  
  --session-accent:#FDBA74;   /* light orange for sessions */
  --meeting-accent:#EA580C;   /* dark orange for meetings */
  --afterhours-accent:#bbf7d0; 
}

/* Make header text readable on the blue background */
header h1,
header .tools { color:#fff; }
header .muted { color:rgba(255,255,255,.85); }
header .tools .btn {
  color: var(--text);
  background:#fff;
  border-color: var(--border);
}
/* Optional: nicer hover for primary buttons & active tabs */
.btn.primary:hover{
  background:var(--primary-hover);
  border-color:var(--primary-hover);
}
.tab.active:hover{
  background:var(--primary-hover);
}
    .brand{display:flex;gap:10px;align-items:center}
.brand-logo{height:28px;width:auto;border-radius:6px;background:#fff;padding:2px;box-shadow:var(--shadow)}
.brand-logo.hidden{display:none}
    .head-left{
  display:flex;
  align-items:center;
  gap:12px;
}
.details-grid{
  display:grid;
  gap:16px;
  grid-template-columns: 1fr 2fr;
}
@media (max-width: 640px){
  .details-grid{
    grid-template-columns: 1fr;
  }
}

/* Reusable avatar image class (lets CSS control size responsively) */
.avatar-img{
  width:44px;
  height:44px;
  object-fit:cover;
  border-radius:999px;
}

/* Make attendee box + photos bigger on mobile */

  /* Editor dialog */
  .ae{ padding:12px; }
  .ae-avatar, .ae-avatar img{ width:64px; height:64px; }
  .ae-grid{ grid-template-columns:72px 1fr; }

  /* Let the LinkedIn button wrap under the name on narrow screens */
  .attendee .row{ flex-wrap:wrap; gap:12px; align-items:flex-start; }
  .attendee .link{ margin-left:72px; }
.brand-logo{
  height:32px;   /* tweak if you want it bigger/smaller */
  width:auto;
  object-fit:contain;
  border-radius:6px; /* optional little rounding */
}
/* Compact GPT card */
#gptCard { 
  margin-bottom: 16px;            /* space before Schedule/Agenda */
}
#gptCard .card-h { 
  padding: 10px 12px;             /* tighter header */
}
#gptCard .tools .btn,
#gptCard .btn.sm {
  padding: 4px 8px;               /* smaller buttons */
  font-size: 12px;
}
#gptCard .desc { 
  margin-top: 6px; 
}

/* If you previously centered the GPT card, undo it */
#gptCard { text-align: left; }
#gptCard .card-h .title { justify-content: flex-start; }
#gptCard .tools { justify-content: flex-start; }
    #gptCard { margin-bottom: 16px; }                /* space before Schedule/Agenda */
#gptCard .card-h { padding: 10px 12px; }         /* tighten vertical padding */

#gptCard .gpt-head {
  align-items: center;
  justify-content: space-between;                /* title left, buttons right */
  gap: 12px;
}

#gptCard .title {
  font-size: 20px;                               /* bigger title */
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: .2px;
}

#gptCard .tools { display: flex; gap: 8px; }
#gptCard .btn.sm { padding: 6px 10px; font-size: 13px; }

#gptCard .desc {
  margin-top: 6px;                               /* small, consistent hint */
  font-size: 12px;
  color: var(--muted);
}

/* If you previously centered GPT content, undo it to avoid odd spacing */
#gptCard, #gptCard .card-h, #gptCard .desc { text-align: left; }
    #gptCard .tools { gap: 10px; }

#gptCard .btn.sm {
  min-height: 40px;      /* taller button */
  padding: 8px 14px;     /* more breathing room */
  font-size: 14px;       /* slightly larger text */
  border-radius: 12px;   /* a touch more rounded */
}
  .attendee .avatar,
.attendee .avatar-img{
  width:72px;
  height:72px;
}

.attendee .name{
  font-size:16px;
  font-weight:700;
  line-height:1.2;
}

.attendee .role{
  font-size:14px;
  color: var(--muted);
}

/* Mobile: even larger */
@media (max-width: 640px){
  .attendee{ padding:16px; }
  .attendee .avatar,
  .attendee .avatar-img{ width:88px; height:88px; }
  .attendee .name{ font-size:18px; }
  .attendee .role{ font-size:15px; }

  /* keep the LinkedIn link aligned to the right of the bigger avatar */
  .attendee .link{ margin-left:96px; }
}
    #gptCard .title {
  font-size: 26px;      /* was 20px */
  line-height: 1.15;
}

/* Large primary button option */
.btn.lg {
  padding: 12px 18px;
  font-size: 16px;
  border-radius: 14px;
  min-height: 48px;
}
  #agendaList .item {
  border-radius: 14px;
  box-shadow: var(--shadow);            /* same subtle lift everywhere */
  border-left-width: 4px;               /* keep the colored bar crisp */
}


#agendaList .item .title { line-height: 1.25; }
#agendaList .item .sub   { margin-top: 4px; white-space: normal; }

/* (already in your CSS, but restated for clarity) */
#agendaList .item.session { border-left-color: var(--session-accent); }
#agendaList .item.meeting { border-left-color: var(--meeting-accent); }
#agendaList .item.session.afterhours { border-left-color: var(--afterhours-accent); }
    :root { --agenda-row-minh: 104px; }          /* tweak: 96–120px works well */

#agendaList .item .item-c {
  min-height: var(--agenda-row-minh);
  padding: 18px 20px;                         /* add a bit more vertical space */
  display: grid;
  grid-template-columns: 1fr auto;            /* text left, tools/chip right */
  align-items: center;
  gap: 14px;
}

/* nicer spacing in the text stack */
#agendaList .item .title { line-height: 1.3; }
#agendaList .item .sub   { margin-top: 6px; white-space: normal; }

/* Slightly shorter on small screens so it doesn’t feel oversized */
@media (max-width: 640px){
  :root { --agenda-row-minh: 88px; }
  #agendaList .item .item-c { padding: 16px 18px; }
}

/* (optional) only make sessions extra-long */
#agendaList .item.session .item-c { min-height: calc(var(--agenda-row-minh) + 8px); }
#agendaList .item .sub {
  white-space: normal;
  max-width: 100%;
}  
  
    #rowDateOnly.hidden { display:none; }
.chip input { margin-right:6px; }
    .item.meeting.clickable { cursor: pointer; }
.pulse { outline: 2px solid var(--blue); box-shadow: 0 0 0 4px var(--primary-50); transition: box-shadow .2s ease; }
    #travelCard .desc { display: none; }
    .legend { display:flex; gap:10px; align-items:center; }
.legend-item { display:inline-flex; align-items:center; gap:6px;
  font-size:12px; padding:4px 8px; border:1px solid var(--border);
  border-radius:999px; background:#fff;
}
.legend-swatch { width:10px; height:10px; border-radius:3px; border:1px solid var(--border); }
/* Optional swatch helpers (uses your existing CSS variables) */
.legend-afterhours { background: var(--afterhours-accent); }
.legend-session    { background: var(--session-accent); }
.legend-meeting    { background: var(--meeting-accent); }
   #travelCard .card-h { 
  padding: 10px 12px;              /* same as #gptCard .card-h */
}
#travelCard .title {
  font-size: 26px;                 /* same as #gptCard .title */
  line-height: 1.15;
}
/* Ensure the collapse icon matches the day nav buttons */
#travelCard .btn.icon {
  width: 36px;
  height: 36px;
} 
    #travelCard .btn.icon { width:36px; height:36px; line-height:1; font-size:18px; }
  </style>

  <!-- Firebase compat SDKs (no build step) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyAefJL7N3PBdQeGJWwjJZjfEQC8qUcpT5U",
    authDomain: "tradeshow-assistant.firebaseapp.com",
    projectId: "tradeshow-assistant",
    storageBucket: "tradeshow-assistant.firebasestorage.app",
    messagingSenderId: "865900601935",
    appId: "1:865900601935:web:82a7b49e70f8088d40003a"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const db = firebase.firestore();
  const COL = db.collection('tradeshow');

  async function getSharedDoc(docId, fallback) {
    const snap = await COL.doc(docId).get();
    return snap.exists ? snap.data().value : fallback;
  }
  async function setSharedDoc(docId, value) {
    return COL.doc(docId).set({ value }, { merge: true });
  }
  function onSharedDoc(docId, cb) {
    return COL.doc(docId).onSnapshot(s => { if (s.exists) cb(s.data().value); });
  
  
}

</script>
</head>
<body>
  <div class="container">
  <header>
  <div class="head-left">
    <h1>
      <!-- Logo replaces the emoji -->
      <img id="brandLogo" class="brand-logo hidden" alt="Company logo" />
        <button id="setLogoBtn" class="btn sm" type="button">🖼️ Set logo</button>
      <input id="logoFile" type="file" accept="image/*" class="hidden" />
  Your Inbound 2025 Assistant
  <span class="muted" style="font-weight:400"></span>
</h1>
      
  </div>
  <div class="tools">
    <div id="importExport"></div>
  </div>
</header>
<div id="gptCard" class="card">
  <div class="card-h">
    <div class="row gpt-head">
      <div class="title">🔗 Ask our GPT</div>
      <div class="tools">
        <a id="openGpt" class="btn sm" href="#" target="_blank" rel="noreferrer">Open GPT</a>
        <button id="setGptBtn" class="btn sm">⚙️ Set Link</button>
        
      </div>
    </div>
    <div id="gptHint" class="desc">No link set yet. Click <em>Set Link</em> to add one.</div>
  </div>
</div>
<div id="travelCard" class="card">
  <div class="card-h">
    <div class="row">
      <div class="title">✈️ Travel</div>
      <button id="travelCollapseBtn" class="btn icon" aria-expanded="true" title="Collapse/expand">▾</button>
    </div>
    <div class="desc">Store flight, hotel, and ground confirmations.</div>
  </div>
  <div class="card-c" id="travelSection"></div>
</div>
    <div class="grid">
      <!-- Left -->
      <div class="col gap16">
        <div class="card">
          <div class="card-h">
            <div class="title">📆 Schedule</div>
            <div class="desc">Switch between an agenda and an hourly grid for any show day.</div>
          </div>
          <div class="card-c">
            <div class="row">
              <div class="tools">
                <button class="btn icon" id="prevDay" title="Previous day">◀</button>
                <div id="activeDateLbl" style="font-weight:600"></div>
                <button class="btn icon" id="nextDay" title="Next day">▶</button>
              </div>
              <div class="tabs">
                <button class="tab active" id="tabAgenda">Agenda</button>
                <button class="tab" id="tabHourly">Hourly</button>
              </div>
            </div>

            <div id="agendaList" class="list" style="margin-top:12px"></div>
            <div id="hourlyGrid" class="hidden" style="margin-top:12px"></div>

            <div class="spacer"></div>
            <button id="addMeetingBtn" class="btn primary wfull">➕ Add meeting</button>
          </div>
        </div>

    
        
      <!-- Right -->
      <div class="col gap16" id="detailsCol"></div>
    </div>
  </div>

  <!-- Dialogs -->
  <dialog id="logoDialog">
  <div class="dialog-c">
    <h3 style="margin:0 0 8px 0">Set logo URL</h3>
    <div class="col gap12">
      <input id="logoInput" placeholder="https://example.com/logo.png" />
      <div class="muted" style="font-size:12px">
        Tip: use a transparent PNG or SVG if you have one.
      </div>
    </div>
  </div>
  <div class="dialog-actions">
    <button class="btn" id="logoCancel">Cancel</button>
    <button class="btn primary" id="logoSave">Save</button>
  </div>
</dialog>
<dialog id="meetingDialog">
  <div class="dialog-c">
    <h3 id="dlgTitle" style="margin:0 0 8px 0">New meeting</h3>
    <div class="col gap12">
      <input id="m_title" placeholder="Title" />
      <div class="two">
        <input id="m_location" placeholder="Location" />
        <input id="m_booth" placeholder="Booth" />
      </div>
      
    <div class="two" id="rowDateTimes">
  <input id="m_start" type="datetime-local" />
  <input id="m_end"   type="datetime-local" />
</div>
  
      <div class="two">
  <label class="chip"><input id="m_dateTBD" type="checkbox"> Date TBD</label>
  <label class="chip"><input id="m_timeTBD" type="checkbox"> Time TBD</label>
</div>

<!-- NEW: date-only when time is TBD -->
<div class="two hidden" id="rowDateOnly">
  <input id="m_dateOnly" type="date" />
  <div></div>
</div>
      <textarea id="m_desc" placeholder="Description / goals"></textarea>

      <div class="kicker">Attendees</div>
      <div id="attendeeEditor" class="col gap12"></div>
      <div class="ae-actions">
        <button type="button" class="btn sm" id="addAttendeeBtn">➕ Add attendee</button>
      </div>
    </div>
  </div>
  <div class="dialog-actions">
    <button class="btn" id="dlgCancel">Cancel</button>
    <button class="btn primary" id="dlgSave">Save</button>
  </div>
</dialog>


  <dialog id="gptDialog">
    <div class="dialog-c">
      <h3 style="margin:0 0 8px 0">Set your GPT link</h3>
      <div class="col gap12">
        <input id="gptInput" placeholder="https://chat.openai.com/g/g-XXXXX-your-gpt"/>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="gptCancel">Cancel</button>
      <button class="btn primary" id="gptSave">Save</button>
    </div>
  </dialog>

  <dialog id="travelDialog">
    <div class="dialog-c">
      <h3 style="margin:0 0 8px 0">New travel</h3>
      <div class="col gap12">
        <div class="two">
          <select id="t_type">
            <option value="flight">Flight</option>
            <option value="hotel">Hotel</option>
            <option value="ground">Ground</option>
          </select>
          <input id="t_label" placeholder="Label (e.g., ATL → BOS)" />
        </div>
        <div class="two">
          <input id="t_conf" placeholder="Confirmation #" />
          <input id="t_details" placeholder="Details" />
        </div>
        <div class="two" id="t_rowDateTime">
          <input id="t_start" type="datetime-local" />
          <input id="t_end" type="datetime-local" />
          </div>

<!-- Show only for hotels -->
<div class="two hidden" id="t_rowDateOnly">
  <input id="t_startDate" type="date" />
  <input id="t_endDate"   type="date" />
</div>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="t_cancel">Cancel</button>
      <button class="btn primary" id="t_save">Save</button>
    </div>
  </dialog>

  <script>
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const uid = () => Math.random().toString(36).slice(2,9);
    const TZ = 'America/Los_Angeles';  
   const fmtTime = (iso) =>
  new Date(iso).toLocaleTimeString([], {
    hour: "2-digit", minute: "2-digit", timeZone: TZ,
        hour12: true  
  });

const fmtDate = (iso) =>
  new Date(iso).toLocaleDateString([], {
    year: "numeric", month: "short", day: "2-digit", timeZone: TZ
  });
  const hoursBetween = (startISO, endISO) =>
  (new Date(endISO).getTime() - new Date(startISO).getTime()) / (1000 * 60 * 60);
    const ptMinutes = (iso) => {
  const parts = new Intl.DateTimeFormat('en-US', {
    timeZone: TZ, hour:'2-digit', minute:'2-digit', hour12:false
  }).formatToParts(new Date(iso));
  const h = +parts.find(p=>p.type==='hour').value;
  const m = +parts.find(p=>p.type==='minute').value;
  return h*60 + m;
};
   const sameDay = (aISO, bISO) => {
  const parts = iso => new Intl.DateTimeFormat('en-CA', {
    timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit'
  }).formatToParts(new Date(iso))
    .reduce((o,p)=> (p.type!=='literal' && (o[p.type]=p.value), o), {});
  const A = parts(aISO), B = parts(bISO);
  return A.year===B.year && A.month===B.month && A.day===B.day;
};
    const TBD_ANCHOR_YMD = '2025-09-02'; // change if you want a different date (PT)

function ymdInTZ(iso){
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit'
  }).formatToParts(new Date(iso))
    .reduce((o,p)=> (p.type!=='literal' && (o[p.type]=p.value), o), {});
  return `${parts.year}-${parts.month}-${parts.day}`;
}
function isAnchorDay(iso){
  return ymdInTZ(iso) === TBD_ANCHOR_YMD;
}
function displayLocation(it){
  if (!it || typeof it !== 'object') return '';
  const keys = [
    'location','Location',
    'stage','Stage',
    'stageName','stage_name','StageName',
    'venue','Venue',
    'room','Room',
    'place','Place',
    'where','Where',
    'locationNote','location_name','LocationName','LocationNote',
    'space','Space','area','Area'
  ];
  const pickString = (v) => {
    if (typeof v === 'string') return v.trim();
    if (Array.isArray(v)) {
      return v.map(x => (typeof x === 'string' ? x.trim()
                 : x && typeof x === 'object' ? (x.name || x.label || '').trim()
                 : ''))
              .filter(Boolean).join(' • ');
    }
    if (v && typeof v === 'object') return (v.name || v.label || v.location || '').toString().trim();
    return '';
  };
  for (const k of keys){
    if (k in it){
      const s = pickString(it[k]);
      if (s) return s;
    }
  }
  return ''; // <-- no booth fallback
}
// (Optional) simple HTML escape since we'll inject into pill HTML


// Basic HTML escape for pill text
function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
    function parseBullets(text){
  if (!text) return [];
  return text
    .split(/\r?\n/)
    .map(s => s.replace(/^\s*([•*-])\s+/, '').trim()) // strip leading bullet markers
    .filter(Boolean);
}

function renderNotes(text){
  const items = parseBullets(text);
  if (items.length >= 2 || /^(\s*[•*-]\s+)/.test(text)) {
    const ul = document.createElement('ul');
    ul.style.margin = '0';
    ul.style.paddingLeft = '18px';
    items.forEach(t => {
      const li = document.createElement('li');
      li.textContent = t;
      ul.append(li);
    });
    return ul;
  } else {
    const p = document.createElement('p');
    p.textContent = (text||'').trim();
    return p;
  }
}
   function focusMeetingInDetails(id){
  const el = document.getElementById(`detail-${id}`);
  if (!el) return;
  el.scrollIntoView({ behavior: "smooth", block: "start" });
  el.classList.add("pulse");
  setTimeout(() => el.classList.remove("pulse"), 1200);
}
   // seed
    const seedDate = (()=>{
      const now = new Date();
      return new Date(now.getFullYear(), 8, 16, 9, 0, 0);
    })();
    const SAMPLE_ATTENDEES = [
      {id:uid(), name:"Chris Williams", title:"VP Partnerships", company:"NorthBridge", linkedin:"", photoUrl:"", notes:"Loves concise dashboards; ask about Zoho practice."},
      {id:uid(), name:"Amanda Lee", title:"Head of Marketing", company:"Protocol80", linkedin:"", photoUrl:"", notes:"Interested in co-marketing webinars and case studies."},
      {id:uid(), name:"Hudson Carter", title:"Solutions Architect", company:"CloudTrailz", linkedin:"", photoUrl:"", notes:"Deep NetSuite background; prefers technical prep notes."},
    ];
    const SAMPLE_MEETINGS = [
      { id:uid(), title:"NorthBridge + Commercient intro", description:"Explore reseller fit; prioritize Zoho + Monday integrations.",
        location:"Hall B – Meeting Room 3", booth:"B122",
        startISO:new Date(seedDate.getTime()).toISOString(),
        endISO:new Date(seedDate.getTime()+60*60*1000).toISOString(),
        attendees:[SAMPLE_ATTENDEES[0]], talkingPoints:"15% target share…", prepChecklist:"Review Zoho…"},
      { id:uid(), title:"Protocol80 co-marketing sprint", description:"Finalize webinar topics and case study pipeline.",
        location:"Expo Café (near Hall A)", booth:"A210",
        startISO:new Date(seedDate.getTime()+2*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()+3*60*60*1000).toISOString(),
        attendees:[SAMPLE_ATTENDEES[1]], talkingPoints:"Partner Spotlight…", prepChecklist:"Bring sample…"},
      { id:uid(), title:"CloudTrailz technical sync", description:"Deep-dive NetSuite<->HubSpot patterns; managed custom objects beta lessons.",
        location:"Booth C341", booth:"C341",
        startISO:new Date(seedDate.getTime()+4*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()+5*60*60*1000).toISOString(),
        attendees:[SAMPLE_ATTENDEES[2]], talkingPoints:"QuickBooks Desktop…", prepChecklist:"Open architecture…"},
    ];
    const SAMPLE_TRAVEL = [
      {id:uid(), type:"flight", label:"ATL → BOS (AC 1234)", confirmation:"Z7X9QW",
        startISO:new Date(seedDate.getTime()-24*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()-22*60*60*1000).toISOString(), details:"Seat 14C; carry-on only."},
      {id:uid(), type:"hotel", label:"Westin Seaport, Boston", confirmation:"H987654",
        startISO:new Date(seedDate.getTime()-1*60*60*1000).toISOString(),
        endISO:new Date(seedDate.getTime()+2*24*60*60*1000).toISOString(), details:"Reservation under Commercient; breakfast included."},
    ];
const MEETINGS = COL.doc('meetings').collection('items');
const TRAVEL   = COL.doc('travel').collection('items');

function upsertMeeting(m){
  const id = m.id || uid();
  return MEETINGS.doc(id).set({ ...m, id }, { merge: true });
}
function deleteMeeting(id){ return MEETINGS.doc(id).delete(); }

function upsertTravel(t){
  const id = t.id || uid();
  return TRAVEL.doc(id).set({ ...t, id }, { merge: true });
}
function deleteTravel(id){ return TRAVEL.doc(id).delete(); }
    // state (will be replaced by Firestore values on load)
    let meetings = structuredClone(SAMPLE_MEETINGS);
    let travel   = structuredClone(SAMPLE_TRAVEL);
    let gptUrl   = "";
let logoUrl = "";
    let activeDate = (meetings[0]?.startISO) || new Date().toISOString();
    let view = "agenda";

    // elements
    const activeDateLbl = $("#activeDateLbl");
    const prevDayBtn = $("#prevDay");
    const nextDayBtn = $("#nextDay");
    const tabAgenda = $("#tabAgenda");
    const tabHourly = $("#tabHourly");
    const agendaList = $("#agendaList");
    const hourlyGrid = $("#hourlyGrid");
    const addMeetingBtn = $("#addMeetingBtn");
    const detailsCol = $("#detailsCol");
    const openGptA = $("#openGpt");
    const setGptBtn = $("#setGptBtn");
    const gptHint = $("#gptHint");
    const travelSection = $("#travelSection");
    const t_rowDateTime = $("#t_rowDateTime");
const t_rowDateOnly = $("#t_rowDateOnly");
const t_startDate   = $("#t_startDate");
const t_endDate     = $("#t_endDate");
    function updateTravelDateInputs(){
  const isHotel = (t_type.value === "hotel");
  t_rowDateTime.classList.toggle("hidden", isHotel);
  t_rowDateOnly.classList.toggle("hidden", !isHotel);
}
const travelCollapseBtn = $("#travelCollapseBtn");

function setTravelCollapsed(collapsed, persist = true){
  $("#travelSection").classList.toggle("hidden", collapsed);
  travelCollapseBtn.setAttribute("aria-expanded", String(!collapsed));
    travelCollapseBtn.textContent = collapsed ? "▼" : "▲";
  travelCollapseBtn.title = collapsed ? "Expand" : "Collapse";
  if (persist) localStorage.setItem("travelCollapsed", collapsed ? "1" : "0");
}
const initialTravelCollapsed = localStorage.getItem("travelCollapsed") === "1";
setTravelCollapsed(initialTravelCollapsed, false);

travelCollapseBtn.onclick = () =>
  setTravelCollapsed(!$("#travelSection").classList.contains("hidden"));
    const brandLogo  = $("#brandLogo");
const setLogoBtn = $("#setLogoBtn");
const logoDialog = $("#logoDialog");
const logoInput  = $("#logoInput");
const logoSave   = $("#logoSave");
const logoCancel = $("#logoCancel");
const logoFile  = $("#logoFile");

    // dialogs
    const meetingDialog = $("#meetingDialog");
    const dlgSave = $("#dlgSave");
    const dlgCancel = $("#dlgCancel");
    const dlgTitle = $("#dlgTitle");
    const m_title = $("#m_title");
    const m_location = $("#m_location");
    const m_booth = $("#m_booth");
    const m_start = $("#m_start");
    const m_end = $("#m_end");
    const m_desc = $("#m_desc");
  const rowDateTimes = $("#rowDateTimes");
const m_dateTBD = $("#m_dateTBD");
const m_timeTBD = $("#m_timeTBD");
const rowDateOnly = $("#rowDateOnly");
const m_dateOnly = $("#m_dateOnly"); 
const attendeeEditorRoot = $("#attendeeEditor");
const addAttendeeBtn = $("#addAttendeeBtn");
let currentAttendees = [];

const blankAttendee = () => ({
  id: uid(), name:"", title:"", company:"", linkedin:"", photoUrl:"", notes:""
});
function sanitizeUrl(u){
  if(!u) return "";
  let s = u.trim();
  if (!/^https?:\/\//i.test(s)) s = "https://" + s;
  return s;
}


function buildAttendeeRow(a){
  const wrap = document.createElement("div");
  wrap.className = "ae";
  wrap.dataset.id = a.id;

  const grid = document.createElement("div");
  grid.className = "ae-grid";

  // Avatar / preview
  const avatar = document.createElement("div");
  avatar.className = "ae-avatar";
  if (a.photoUrl) {
    const img = document.createElement("img");
    img.src = a.photoUrl;
    avatar.append(img);
  } else {
    avatar.textContent = (a.name || "?").slice(0,1).toUpperCase();
  }

  // Right side
  const right = document.createElement("div");
  right.className = "col gap8";

  // Row 1: name + title
  const row1 = document.createElement("div");
  row1.className = "ae-two";
  const inName = document.createElement("input");
  inName.placeholder = "Full name";
  inName.value = a.name || "";
  inName.name = "a_name";

  const inTitle = document.createElement("input");
  inTitle.placeholder = "Job title";
  inTitle.value = a.title || "";
  inTitle.name = "a_title";
  row1.append(inName, inTitle);

  // Row 2: company + linkedin (+ Open button)
  const row2 = document.createElement("div");
  row2.className = "ae-two";

  const inCompany = document.createElement("input");
  inCompany.placeholder = "Company";
  inCompany.value = a.company || "";
  inCompany.name = "a_company";

  const linkWrap = document.createElement("div");
  linkWrap.className = "ae-linkwrap";

  const inLinkedin = document.createElement("input");
  inLinkedin.placeholder = "LinkedIn URL (https://…)";
  inLinkedin.value = a.linkedin || "";
  inLinkedin.name = "a_linkedin";

  const btnOpen = document.createElement("button");
  btnOpen.className = "btn sm";
  btnOpen.type = "button";
  btnOpen.textContent = "🔗 Open";
  btnOpen.disabled = !inLinkedin.value.trim();

  btnOpen.onclick = () => {
    const url = sanitizeUrl(inLinkedin.value);
    if(!url) return;
    window.open(url, "_blank", "noopener,noreferrer");
  };
  inLinkedin.addEventListener("input", () => {
    btnOpen.disabled = !inLinkedin.value.trim();
  });

  linkWrap.append(inLinkedin, btnOpen);
  row2.append(inCompany, linkWrap);

  // Photo controls: hidden data URL, file input, clear button
  const inPhotoHidden = document.createElement("input");
  inPhotoHidden.type = "hidden";
  inPhotoHidden.name = "a_photo";
  inPhotoHidden.value = a.photoUrl || "";

  const inPhotoFile = document.createElement("input");
  inPhotoFile.type = "file";
  inPhotoFile.accept = "image/*";

  const btnClearPhoto = document.createElement("button");
  btnClearPhoto.className = "btn sm";
  btnClearPhoto.type = "button";
  btnClearPhoto.textContent = "🧹 Clear photo";
  btnClearPhoto.style.marginLeft = "8px";
  btnClearPhoto.onclick = () => {
    a.photoUrl = "";
    inPhotoHidden.value = "";
    avatar.innerHTML = (inName.value || "?").slice(0,1).toUpperCase();
  };

  inPhotoFile.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const dataUrl = await fileToDataUrl(file, { maxW: 256, maxH: 256, quality: 0.9 });
      a.photoUrl = dataUrl;
      inPhotoHidden.value = dataUrl;

      avatar.innerHTML = "";
      const img2 = document.createElement("img");
      img2.src = dataUrl;
      avatar.append(img2);
    } catch (err) {
      console.error(err);
      alert("Could not read that image. Try a PNG or JPG.");
    } finally {
      inPhotoFile.value = "";
    }
  });

  // keep the initial letter live if there's no photo
  inName.addEventListener("input", () => {
    if (!inPhotoHidden.value){
      avatar.textContent = (inName.value || "?").slice(0,1).toUpperCase();
    }
  });

  const photoRow = document.createElement("div");
  photoRow.className = "ae-two";
  const photoLeft = document.createElement("div");
  const photoRight = document.createElement("div");
  photoLeft.append(inPhotoFile, btnClearPhoto);
  photoRow.append(photoLeft, photoRight);

  // Notes
  const inNotes = document.createElement("textarea");
  inNotes.placeholder = "Notes";
  inNotes.value = a.notes || "";

  // Remove button
  const actions = document.createElement("div");
  actions.className = "ae-actions";
  const btnRemove = document.createElement("button");
  btnRemove.className = "btn sm";
  btnRemove.textContent = "🗑️ Remove";
  btnRemove.onclick = () => {
    currentAttendees = currentAttendees.filter(x => x.id !== a.id);
    renderAttendeeEditor(currentAttendees);
  };
  actions.append(btnRemove);

  // Assemble
  right.append(row1, row2, photoRow, inPhotoHidden, inNotes);
  grid.append(avatar, right);
  wrap.append(grid, actions);
  return wrap;
}

function renderAttendeeEditor(list){
  attendeeEditorRoot.innerHTML = "";
  if (!list || list.length === 0){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "No attendees yet.";
    attendeeEditorRoot.append(empty);
    return;
  }
  list.forEach(a => attendeeEditorRoot.append(buildAttendeeRow(a)));
}

function collectAttendeesFromEditor(){
  const rows = Array.from(attendeeEditorRoot.querySelectorAll(".ae"));
  return rows.map(row => {
    const id = row.dataset.id;
    const inName     = row.querySelector('input[name="a_name"]');
    const inTitle    = row.querySelector('input[name="a_title"]');
    const inCompany  = row.querySelector('input[name="a_company"]');
    const inLinkedin = row.querySelector('input[name="a_linkedin"]');
    const inPhoto    = row.querySelector('input[name="a_photo"]');
    const inNotes    = row.querySelector('textarea');

    return {
      id,
      name: (inName?.value || "").trim(),
      title: (inTitle?.value || "").trim(),
      company: (inCompany?.value || "").trim(),
      linkedin: (inLinkedin?.value || "").trim(),
      photoUrl: (inPhoto?.value || "").trim(),   // data URL from the file upload
      notes: (inNotes?.value || "").trim(),
    };
  });
}

    const gptDialog = $("#gptDialog");
    const gptInput = $("#gptInput");
    const gptSave = $("#gptSave");
    const gptCancel = $("#gptCancel");
const t_label = $("#t_label");
    const travelDialog = $("#travelDialog");
    const t_type = $("#t_type");
    const t_conf = $("#t_conf");
    const t_details = $("#t_details");
    const t_start = $("#t_start");
    const t_end = $("#t_end");
    const t_save = $("#t_save");
    const t_cancel = $("#t_cancel");

function daysFromCalendar(){
  const fmt = new Intl.DateTimeFormat('en-CA', {
    timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit'
  });
  const byDay = new Map();

  // include meetings that have a date (dateTBD=false) + all sessions
  [...meetings.filter(m => !m.dateTBD), ...sessions].forEach(x => {
    const k = fmt.format(new Date(x.startISO));
    const cur = byDay.get(k);
    if (!cur || new Date(x.startISO) < new Date(cur)) byDay.set(k, x.startISO);
  });

  // ensure the anchor day appears if we have any Date TBD meetings
  if (meetings.some(m => m.dateTBD) && !byDay.has(TBD_ANCHOR_YMD)) {
    byDay.set(TBD_ANCHOR_YMD, new Date('2025-09-02T12:00:00Z').toISOString());
  }

  return Array.from(byDay.values()).sort((a,b)=> new Date(a) - new Date(b));
}
 function shiftDay(dir){
   const days = daysFromCalendar();
  const idx = days.findIndex(d => sameDay(d, activeDate)); // both ISO strings
  const next = days[idx + dir];
  if (next) activeDate = next;
  renderAll();
}
    function renderHeaderControls(){
      activeDateLbl.textContent = fmtDate(activeDate);
      tabAgenda.classList.toggle("active", view==="agenda");
      tabHourly.classList.toggle("active", view==="hourly");
    }
const SESSIONS = COL.doc('sessions').collection('items');

// Helpers
function upsertSession(s){
  const id = s.id || uid();
  return SESSIONS.doc(id).set({ ...s, id }, { merge:true });
}
function deleteSession(id){ return SESSIONS.doc(id).delete(); }

// State
let sessions = [];
 SESSIONS.orderBy('startISO').onSnapshot(async snap => {
  sessions = snap.docs.map(d => d.data());
  const sDays = daysFromCalendar();
  if (sDays.length && !sDays.some(d => sameDay(d, activeDate))) activeDate = sDays[0];
  renderAll();
});
function itemsForDay(iso){
  const m = meetings
    .filter(x => sameDay(x.startISO, iso))
    .map(x => ({ ...x, kind: 'meeting' }));

  const s = sessions
    .filter(x => sameDay(x.startISO, iso))
    .map(x => ({ ...x, kind: 'session' }));

  return [...m, ...s].sort((a,b)=> new Date(a.startISO) - new Date(b.startISO));
}
 function renderAgenda(){
  agendaList.innerHTML = "";

  // Unscheduled (date TBD) section (only on anchor day)
  const unscheduled = meetings.filter(m => m.dateTBD);
  if (isAnchorDay(activeDate) && unscheduled.length){
    const hdr = document.createElement("div");
    hdr.className = "kicker";
    hdr.textContent = "Unscheduled (TBD date)";
    agendaList.append(hdr);

    unscheduled.forEach(m => {
      const card = document.createElement("div"); card.className = "item meeting clickable";
      const c = document.createElement("div"); c.className = "item-c";
      const left = document.createElement("div");

      const title = document.createElement("div"); title.className = "title";
      title.textContent = `TBD • ${m.title}`;

      const sub = document.createElement("div"); sub.className = "sub";
      const loc = displayLocation(m);
      const booth = m.booth ? `Booth ${m.booth}` : "";
      sub.textContent = [loc, booth].filter(Boolean).join(" • ");

      left.append(title, sub);

      const tools = document.createElement("div"); tools.className="tools";
      const edit = document.createElement("button"); edit.className="btn sm"; edit.textContent="✏️";
      edit.onclick = (e) => { e.stopPropagation(); openMeetingDialog(m); };
      const del = document.createElement("button"); del.className="btn sm"; del.textContent="🗑️";
      del.onclick  = async (e) => {
        e.stopPropagation();
        if (!confirm("Delete this meeting?")) return;
        try { await deleteMeeting(m.id); } catch(e){ console.error(e); alert("Delete failed."); }
      };
      tools.append(edit, del);

      c.append(left, tools);
      card.append(c);
      card.addEventListener("click", () => focusMeetingInDetails(m.id));
      agendaList.append(card);
    });

    const spacer = document.createElement("div"); spacer.className = "spacer";
    agendaList.append(spacer);
  }

  // Scheduled items for the active day
  const items = itemsForDay(activeDate);
  if (items.length === 0){
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = "No scheduled items for this date.";
    agendaList.append(div);
    return;
  }

  items.forEach(it => {
    const card = document.createElement("div");
    card.className = "item";
    if (it.kind === 'session') card.classList.add('session');
    else if (it.kind === 'meeting') card.classList.add('meeting');

    if (it.kind === 'session' && (it.afterHours || it.category === 'afterHours')){
      card.classList.add('afterhours');
    }

    const c = document.createElement("div"); c.className = "item-c";

    const left = document.createElement("div");
    const title = document.createElement("div"); title.className = "title";
    const tLabel = (it.dateTBD || it.timeTBD) ? "TBD" : `${fmtTime(it.startISO)}–${fmtTime(it.endISO)}`;
    title.textContent = `${tLabel} • ${it.title}`;

    const sub = document.createElement("div"); sub.className = "sub";
    const loc = displayLocation(it);
    const booth = it.booth ? `Booth ${it.booth}` : "";
    sub.textContent = [loc, booth].filter(Boolean).join(" • ");
    left.append(title, sub);

    const tools = document.createElement("div"); tools.className = "tools";
    if (it.kind === 'meeting') {
      const edit = document.createElement("button"); edit.className="btn sm"; edit.textContent="✏️";
      edit.onclick = (e) => { e.stopPropagation(); openMeetingDialog(it); };

      const del = document.createElement("button"); del.className="btn sm"; del.textContent="🗑️";
      del.onclick = async (e) => {
        e.stopPropagation();
        if (!confirm("Delete this meeting?")) return;
        try { await deleteMeeting(it.id); } catch(e){ console.error(e); alert("Delete failed."); }
      };

      tools.append(edit, del);
    } else {
      const chip = document.createElement("span"); chip.className = "chip"; chip.textContent = "SESSION";
      tools.append(chip);
    }

    c.append(left, tools);
    card.append(c);

    if (it.kind === 'meeting') {
      card.classList.add('clickable');
      card.addEventListener('click', () => focusMeetingInDetails(it.id));
    }

    agendaList.append(card);
  });
}

function renderHourly(){
  hourlyGrid.innerHTML = "";
  const items = itemsForDay(activeDate);

  const wrap = document.createElement("div");
  wrap.className = "hour-grid";

  // --- TBD time pills for meetings on this date ---
  const tbdToday = meetings.filter(
    m => !m.dateTBD && m.timeTBD && sameDay(m.startISO, activeDate)
  );
  if (tbdToday.length){
    const row  = document.createElement("div"); row.className  = "hour-row";
    const lbl  = document.createElement("div"); lbl.className  = "hour-label"; lbl.textContent = "TBD";
    const cell = document.createElement("div"); cell.className = "hour-cell";

    const box = document.createElement("div");
    box.style.display = "flex"; box.style.flexWrap = "wrap"; box.style.gap = "8px";
tbdToday.forEach(it => {
  const pill = document.createElement("span");
  pill.className = "meeting-pill meeting";
  pill.style.cursor = "pointer";
  pill.addEventListener("click", () => focusMeetingInDetails(it.id));

const loc   = displayLocation(it);
const booth = it.booth ? `Booth ${escapeHtml(it.booth)}` : "";
const where = [loc, booth].filter(Boolean).join(" • ");
const meta  = where ? `TBD • ${where}` : "TBD";
   pill.innerHTML = `<strong>${escapeHtml(it.title)}</strong> <span class="muted">${meta}</span>`;

  box.append(pill);
});
    cell.append(box);
    row.append(lbl, cell);
    wrap.append(row);
  }
    
  // --- Hourly grid (PT) ---
  const startHour = 7;        // 7 AM PT
  const hoursToShow = 17;     // 7am–11pm

  const labelFromHour = (hr) => {
    const h12 = ((hr + 11) % 12) + 1;
    const ampm = hr < 12 ? "AM" : "PM";
    return `${h12.toString().padStart(2,"0")}:00 ${ampm}`;
  };

  for (let i = 0; i < hoursToShow; i++){
    const hr = startHour + i;

    const row  = document.createElement("div"); row.className  = "hour-row";
    const lbl  = document.createElement("div"); lbl.className  = "hour-label"; lbl.textContent = labelFromHour(hr);
    const cell = document.createElement("div"); cell.className = "hour-cell";

    const slot = items
      .filter(it => {
        if (it.dateTBD || it.timeTBD) return false;       // skip unscheduled here
        const s = ptMinutes(it.startISO);                 // minutes since midnight PT
        return Math.floor(s / 60) === hr;                 // bucket by START hour only
      })
      .sort((a,b) => new Date(a.startISO) - new Date(b.startISO));

    if (slot.length === 0){
      const g = document.createElement("div");
      g.className = "ghost";
      cell.append(g);
    } else {
      const box = document.createElement("div");
      box.style.display = "flex"; box.style.flexWrap = "wrap"; box.style.gap = "8px";

      slot.forEach(it => {
        const pill = document.createElement("span");
        pill.className = "meeting-pill";
        if (it.kind === "session") pill.classList.add("session");
        else if (it.kind === "meeting") pill.classList.add("meeting");
        if (it.kind === "session" && (it.afterHours || it.category === "afterHours")){
          pill.classList.add("afterhours");
        }
if (it.kind === "meeting") {
  pill.style.cursor = "pointer";
  pill.addEventListener("click", () => focusMeetingInDetails(it.id));
}
   const loc   = displayLocation(it);
const booth = it.booth ? `Booth ${escapeHtml(it.booth)}` : "";
const where = [loc, booth].filter(Boolean).join(" • ");

const timeRange = `${fmtTime(it.startISO)}–${fmtTime(it.endISO)}`;
const meta = where ? `${timeRange} • ${where}` : timeRange;

pill.innerHTML = `<strong>${escapeHtml(it.title)}</strong> <span class="muted">${meta}</span>`;
        box.append(pill);
      });

      cell.append(box);
    }

    row.append(lbl, cell);
    wrap.append(row);
  }

  hourlyGrid.append(wrap);
}

function renderDetails(){
  detailsCol.innerHTML = "";
const dayMeetings = meetings
  .filter(m =>
    // normal same-day meetings
    sameDay(m.startISO, activeDate) ||
    // ALSO include Date TBD meetings when viewing the anchor day
    (m.dateTBD && isAnchorDay(activeDate))
  )
  .sort((a,b) => {
    // Optional: show Date TBD first
    if (a.dateTBD && !b.dateTBD) return -1;
    if (!a.dateTBD && b.dateTBD) return 1;
    return new Date(a.startISO) - new Date(b.startISO);
  });
  if(dayMeetings.length===0){
    const card = document.createElement("div"); card.className="card";
    card.innerHTML = `<div class="card-h"><div class="title">No meetings this day</div></div>
                      <div class="card-c muted">Add one using the button on the left.</div>`;
    detailsCol.append(card);
    return;
  }

  dayMeetings.forEach(m => {
    const card = document.createElement("div"); 
    card.className = "card";
card.id = `detail-${m.id}`;

    const head = document.createElement("div"); 
    head.className = "card-h";

    // Title row
    const t = document.createElement("div"); 
    t.className = "title row";
    const leftT = document.createElement("span"); 
    leftT.textContent = m.title;
    const rightT = document.createElement("span"); 
    rightT.className = "muted";

    let timePart;
    if (m.dateTBD) timePart = "TBD date";
    else if (m.timeTBD) timePart = "TBD time";
    else timePart = `${fmtTime(m.startISO)}–${fmtTime(m.endISO)}`;

    const dateLabel =
  (m.dateTBD && isAnchorDay(activeDate)) ? fmtDate(activeDate) :
  m.dateTBD ? 'TBD' : fmtDate(m.startISO);

rightT.textContent = `${dateLabel} • ${timePart}`;
    t.append(leftT, rightT);
    head.append(t);

    // Sub-desc (duration + location)
    const desc = document.createElement("div");
    desc.className = "desc";
    const where = displayLocation(m);
    const dur = (!m.dateTBD && !m.timeTBD) ? `${hoursBetween(m.startISO, m.endISO).toFixed(1)} hrs` : "TBD";
    desc.textContent = where ? `${dur} • ${where}` : dur;
    head.append(desc);

    // Body
    const c = document.createElement("div"); 
    c.className = "card-c";

    const inner = document.createElement("div");
    inner.className = "details-grid";
    inner.style.gridTemplateColumns="1fr 2fr";
    inner.style.gap="16px";

    // Left column: description + talking points + prep
    const leftCol = document.createElement("div");
    if (m.description) { leftCol.append(renderNotes(m.description)); }
  if (m.talkingPoints){
  const k=document.createElement("div"); k.className="kicker"; k.textContent="Suggested talking points";
  const box=document.createElement("div"); box.style.background="var(--primary-50)"; box.style.borderRadius="12px"; box.style.padding="12px";
  box.append(renderNotes(m.talkingPoints));
  leftCol.append(k, box);
}
    if (m.prepChecklist){
  const k=document.createElement("div"); k.className="kicker"; k.textContent="Prep checklist";
  const box=document.createElement("div"); box.style.background="var(--primary-50)"; box.style.borderRadius="12px"; box.style.padding="12px";
  box.append(renderNotes(m.prepChecklist));
  leftCol.append(k, box);
}
    const edit = document.createElement("button"); edit.className="btn"; edit.textContent="✏️ Edit details";
    edit.onclick = ()=> openMeetingDialog(m);
    leftCol.append(edit);

    // Right column: attendees
    const rightCol = document.createElement("div");
    const ak = document.createElement("div"); ak.className="kicker"; ak.textContent="Attendees";
    rightCol.append(ak);
    (m.attendees||[]).forEach(a => {
      const wrap = document.createElement("div"); wrap.className="attendee";
      const row = document.createElement("div"); row.className="row";
      const who = document.createElement("div"); who.className="row"; who.style.gap="12px";
      const av = document.createElement("div"); av.className = "avatar";
      if (a.photoUrl) {
        const img = document.createElement("img"); img.src = a.photoUrl; img.alt = a.name || "Photo"; img.className = "avatar-img";
        av.append(img);
      } else {
        av.textContent = (a.name || "?").slice(0,1).toUpperCase();
      }
      const meta = document.createElement("div");
      const nm = document.createElement("div"); nm.className = "name"; nm.textContent = a.name;
      const sub = document.createElement("div"); sub.className = "role"; sub.textContent = [a.title, a.company].filter(Boolean).join(" • ");
      meta.append(nm, sub);
      who.append(av, meta);

      const link = document.createElement("a"); link.className="link"; link.textContent="LinkedIn"; link.target="_blank"; link.rel="noreferrer";
      if(a.linkedin) link.href=a.linkedin; else { link.href="#"; link.style.pointerEvents="none"; link.style.opacity=".5"; }

      row.append(who, link);
      if(a.notes){
        const notes=document.createElement("div"); notes.style.marginTop="6px"; notes.textContent=a.notes; 
        wrap.append(row, notes);
      } else {
        wrap.append(row);
      }
      rightCol.append(wrap);
    });

    inner.append(rightCol, leftCol);
    c.append(inner);
    card.append(head, c);
    detailsCol.append(card);
  });
}
function updateTbdUI(){
  const dateTBD = m_dateTBD.checked;
  const timeTBD = m_timeTBD.checked;

  if (dateTBD){
    // No date, no time
    rowDateTimes.classList.add("hidden");
    rowDateOnly.classList.add("hidden");
  } else if (timeTBD){
    // Date known, time unknown
    rowDateTimes.classList.add("hidden");
    rowDateOnly.classList.remove("hidden");
  } else {
    // Normal
    rowDateTimes.classList.remove("hidden");
    rowDateOnly.classList.add("hidden");
  }
}
m_dateTBD.onchange = updateTbdUI;
m_timeTBD.onchange = updateTbdUI;
function renderTravel(){
  const root = travelSection;
  root.innerHTML = "";

  const add = document.createElement("button");
  add.className = "btn";
  add.textContent = "➕ Add travel";
  add.onclick = () => {
    t_type.value   = "flight";
    t_label.value  = "";
    t_conf.value   = "";
    t_details.value= "";
    t_start.value  = "";
    t_end.value    = "";
    t_startDate.value = "";
    t_endDate.value   = "";

    updateTravelDateInputs();      // show datetime by default for flight
    travelDialog.dataset.editId = "";
    travelDialog.showModal();
  };
  root.append(add);

  const spacer = document.createElement("div");
  spacer.className = "spacer";
  root.append(spacer);

  if (travel.length === 0){
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = "No travel saved.";
    root.append(div);
    return;
  }

  travel.forEach(t => {
    const row   = document.createElement("div"); row.className = "item";
    const inner = document.createElement("div"); inner.className = "item-c";

    const left  = document.createElement("div");
    const head  = document.createElement("div"); head.className = "title";
    head.textContent = `[${t.type.toUpperCase()}] ${t.label}`;

    const sub   = document.createElement("div");
    sub.className = "muted";
    sub.style.fontSize = "12px";

    const bits = [];
    if (t.confirmation) bits.push(`Conf#: ${t.confirmation}`);
    if (t.type === "hotel"){
      if (t.startISO) bits.push(`Check-in ${fmtDate(t.startISO)}`);
      if (t.endISO)   bits.push(`Check-out ${fmtDate(t.endISO)}`);
    } else {
      if (t.startISO) bits.push(`Start ${fmtDate(t.startISO)} ${fmtTime(t.startISO)}`);
      if (t.endISO)   bits.push(`End ${fmtDate(t.endISO)} ${fmtTime(t.endISO)}`);
    }
    sub.textContent = bits.join(" • ");

    if (t.details){
      const d = document.createElement("div");
      d.style.fontSize = "12px";
      d.textContent = t.details;
      left.append(head, sub, d);
    } else {
      left.append(head, sub);
    }

    const tools = document.createElement("div"); tools.className = "tools";
    const edit  = document.createElement("button"); edit.className = "btn sm"; edit.textContent = "✏️";
    edit.onclick = () => {
      t_type.value   = t.type;
      t_label.value  = t.label;
      t_conf.value   = t.confirmation || "";
      t_details.value= t.details || "";
function toYMD(iso){
  if (!iso) return "";
  const d = new Date(iso);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
      // populate date/datetime inputs based on type
      if (t.type === "hotel"){
        t_startDate.value = toYMD(t.startISO);
        t_endDate.value   = toYMD(t.endISO);
        t_start.value = ""; t_end.value = "";
      } else {
        t_start.value = t.startISO ? new Date(t.startISO).toISOString().slice(0,16) : "";
        t_end.value   = t.endISO   ? new Date(t.endISO).toISOString().slice(0,16)   : "";
        t_startDate.value = ""; t_endDate.value = "";
      }

      updateTravelDateInputs();
      travelDialog.dataset.editId = t.id;
      travelDialog.showModal();
    };

    const del = document.createElement("button"); del.className = "btn sm"; del.textContent = "🗑️";
    del.onclick = async () => {
      if (!confirm("Delete this travel item?")) return;
      try { await deleteTravel(t.id); }
      catch(e){ console.error(e); alert("Delete failed."); }
    };

    tools.append(edit, del);
    inner.append(left, tools);
    row.append(inner);
    root.append(row);
  });
}
  function openMeetingDialog(m){
  meetingDialog.dataset.editId = m?.id || "";
  dlgTitle.textContent = m ? "Edit meeting" : "New meeting";
  m_title.value = m?.title || "";
  m_location.value = m?.location || "";
  m_booth.value = m?.booth || "";

  const toLocalInput = (d) => {
    const dt = new Date(d);
    dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
    return dt.toISOString().slice(0,16);
  };

  // Default datetimes (normal case)
  m_start.value = toLocalInput(m ? m.startISO : new Date());
  m_end.value   = toLocalInput(m ? m.endISO   : new Date(Date.now()+60*60*1000));
  m_desc.value  = m?.description || "";

  // NEW: set TBD flags from doc (booleans)
  m_dateTBD.checked = !!m?.dateTBD;
  m_timeTBD.checked = !!m?.timeTBD;

  // NEW: if time-only TBD, seed the date picker from startISO (or today)
  if (!m_dateTBD.checked && m_timeTBD.checked){
    const base = m?.startISO ? new Date(m.startISO) : new Date();
    // YYYY-MM-DD for the <input type="date">
    const yyyy = base.getFullYear();
    const mm = String(base.getMonth()+1).padStart(2,'0');
    const dd = String(base.getDate()).padStart(2,'0');
    m_dateOnly.value = `${yyyy}-${mm}-${dd}`;
  } else {
    m_dateOnly.value = "";
  }

  // NEW: reflect correct rows
  updateTbdUI();

  // Load attendees (unchanged)
  currentAttendees = Array.isArray(m?.attendees) ? structuredClone(m.attendees) : [];
  renderAttendeeEditor(currentAttendees);
  addAttendeeBtn.onclick = () => {
    currentAttendees = [...currentAttendees, blankAttendee()];
    renderAttendeeEditor(currentAttendees);
  };


  meetingDialog.showModal();
}
async function saveMeetingFromDialog(){
  const id = meetingDialog.dataset.editId;
  const dateTBD = m_dateTBD.checked;
  const timeTBD = m_timeTBD.checked;

  const base = {
    id: id || uid(),
    title: m_title.value.trim(),
    location: m_location.value.trim(),
    booth: m_booth.value.trim(),
    attendees: collectAttendeesFromEditor(),
    description: m_desc.value.trim(),
    dateTBD,
    timeTBD
  };
  if (!base.title){ alert("Title required"); return; }

  // Decide how we store timing
  if (dateTBD){
    // Unknown date/time: keep an anchor so Firestore orderBy('startISO') works,
    // but we will explicitly ignore dateTBD in all day calculations.
    base.startISO = new Date(0).toISOString();            // Jan 1, 1970
    base.endISO   = new Date(60*60*1000).toISOString();   // +1h
    base.dateOnly = "";                                    // none
  } else if (timeTBD){
    // Date known, time unknown: we store midnight for grouping by day,
    // and render "TBD" instead of the time.
    if (!m_dateOnly.value){ alert("Pick a date (or mark Date TBD)."); return; }
    const d = new Date(m_dateOnly.value);                 // local midnight
    base.startISO = d.toISOString();
    base.endISO   = new Date(d.getTime() + 60*60*1000).toISOString(); // +1h
    base.dateOnly = m_dateOnly.value;                     // 'YYYY-MM-DD' for convenience
  } else {
    // Normal meeting
    const start = new Date(m_start.value);
    const end   = new Date(m_end.value);
    if (!(m_start.value && m_end.value)){ alert("Start and end are required (or mark TBD)."); return; }
    if (end <= start){ alert("End time must be after start time."); return; }
    base.startISO = start.toISOString();
    base.endISO   = end.toISOString();
    base.dateOnly = "";
  }

  const now = Date.now();
  if (!id) base.createdAtMs = now;
  base.updatedAtMs = now;

  try {
    await upsertMeeting(base);
    meetingDialog.close();
  } catch (e){
    console.error(e);
    alert('Cloud save failed.');
  }
}

    function renderGpt(){
  const has = !!gptUrl;
  if (has){
    openGptA.href = gptUrl;
    openGptA.removeAttribute('disabled');
    openGptA.classList.add('lg');          // make it bigger
    gptHint.style.display = "none";
    setGptBtn.style.display = "none";      // hide Set Link when set
  }else{
    openGptA.href = "#";
    openGptA.setAttribute('disabled', ''); // no link yet
    openGptA.classList.remove('lg');
    gptHint.style.display = "block";
    setGptBtn.style.display = "inline-flex";
  }
}
function renderLogo(){
  // If there's no saved URL: hide image, show the button, and bail.
  if (!logoUrl) {
    brandLogo.removeAttribute('src');
    brandLogo.classList.add('hidden');
    setLogoBtn.classList.remove('hidden');
    return;
  }

  // Verify the URL loads before we hide the button.
  const probe = new Image();
  probe.onload = () => {
    brandLogo.src = logoUrl;
    brandLogo.classList.remove('hidden');
    setLogoBtn.classList.add('hidden');  // hide only after a successful load
  };
  probe.onerror = async () => {
    // Bad URL: clear it so the button comes back.
    brandLogo.removeAttribute('src');
    brandLogo.classList.add('hidden');
    setLogoBtn.classList.remove('hidden');
    logoUrl = '';
    await setSharedDoc('logoUrl', '');
  };
  probe.src = logoUrl;
}

async function renderImportExport(){
   const root = document.createElement("div");
  root.className = "legend";
    root.innerHTML = `
    <span class="legend-item">
      <span class="legend-swatch legend-meeting"></span>
      Meetings
    </span>
    <span class="legend-item">
      <span class="legend-swatch legend-session"></span>
      Sessions
    </span>
    <span class="legend-item">
      <span class="legend-swatch legend-afterhours"></span>
      After-hours events
    </span>`;

  const slot = document.getElementById("importExport");
  slot.innerHTML = "";
  slot.append(root);
}

    // --- helper to merge by 'id' and skip stale docs (older updatedAtMs) ---
    async function mergeCollection(colRef, incoming) {
      // build a map of current docs
      const curSnap = await colRef.get();
      const curMap = new Map(curSnap.docs.map(d => [d.id, d.data()]));

      const batch = db.batch();

      for (const obj of incoming) {
        // ensure an id
        const id = obj.id || uid();
        obj.id = id;

        const existing = curMap.get(id);
        const incomingUpdated = obj.updatedAtMs ?? 0;
        const existingUpdated = existing?.updatedAtMs ?? 0;

        // only write if:
        //  - new doc OR
        //  - incoming is same/newer than existing
        if (!existing || incomingUpdated >= existingUpdated) {
          // never drop fields that already exist in Firestore: merge: true
          batch.set(colRef.doc(id), obj, { merge: true });
        }
      }

      await batch.commit();
    }

    // Merge-only; do NOT delete anything
    await mergeCollection(MEETINGS, meetingsIn);
    await mergeCollection(TRAVEL,   travelIn);
    await mergeCollection(SESSIONS, sessionsIn);

    // Small settings (merge is fine here too)
    if ('gptUrl'  in parsed) await setSharedDoc('gptUrl',  parsed.gptUrl  || '');
    if ('logoUrl' in parsed) await setSharedDoc('logoUrl', parsed.logoUrl || '');

    alert('Import complete (merged). Local edits preserved.');
  } catch(err) {
    console.error(err);
    alert("Invalid JSON file");
  } finally {
    inp.value = '';
  }
};

  // EXPORT
  btnExport.onclick = async () => {
    const [msSnap, tsSnap, ssSnap] = await Promise.all([
      MEETINGS.get(),
      TRAVEL.get(),
      SESSIONS.get()
    ]);
    const file = {
      meetings: msSnap.docs.map(d => d.data()),
      travel:   tsSnap.docs.map(d => d.data()),
      sessions: ssSnap.docs.map(d => d.data()),
      gptUrl,
      logoUrl
    };
    const blob = new Blob([JSON.stringify(file, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `tradeshow-data-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  root.append(btnImport, btnExport, inp);
  $("#importExport").innerHTML = "";
  $("#importExport").append(root);
}
    // event wiring
    prevDayBtn.onclick = ()=> shiftDay(-1);
    nextDayBtn.onclick = ()=> shiftDay(1);
    tabAgenda.onclick = ()=>{ view="agenda"; renderAll(); };
    tabHourly.onclick = ()=>{ view="hourly"; renderAll(); };
    addMeetingBtn.onclick = ()=> openMeetingDialog();
    dlgCancel.onclick = ()=> meetingDialog.close();
    dlgSave.onclick = ()=> saveMeetingFromDialog();

    setGptBtn.onclick = ()=>{ gptInput.value = gptUrl || ""; gptDialog.showModal(); };
    gptCancel.onclick = ()=> gptDialog.close();
    gptSave.onclick = async ()=>{ gptUrl = (gptInput.value||"").trim(); await setSharedDoc('gptUrl', gptUrl); gptDialog.close(); };

    t_cancel.onclick = ()=> travelDialog.close();
    t_type.addEventListener("change", updateTravelDateInputs);
t_save.onclick = async () => {
  const id = travelDialog.dataset.editId;
  const payload = {
    id: id || uid(),
    type: t_type.value,
    label: t_label.value.trim(),
    confirmation: t_conf.value.trim(),
    details: t_details.value.trim(),
  };

  if (!payload.label){ alert("Label required"); return; }

  if (t_type.value === "hotel") {
    // date-only: store midnight UTC for both (or whichever provided)
    if (t_startDate.value) payload.startISO = new Date(`${t_startDate.value}T12:00:00`).toISOString();
    if (t_endDate.value)   payload.endISO   = new Date(`${t_endDate.value}T12:00:00`).toISOString();
  } else {
    // datetime for flights/ground
    if (t_start.value) payload.startISO = new Date(t_start.value).toISOString();
    if (t_end.value)   payload.endISO   = new Date(t_end.value).toISOString();
    if (payload.startISO && payload.endISO && new Date(payload.endISO) < new Date(payload.startISO)){
      alert("Travel end must be after start."); return;
    }
  }

  const now = Date.now();
  if (!id) payload.createdAtMs = now;
  payload.updatedAtMs = now;

  try {
    await upsertTravel(payload);
    travelDialog.close();
  } catch (e){
    console.error(e);
    alert('Save failed.');
  }
};
setLogoBtn.addEventListener('click', () => {
  logoFile.click();
});

// When a file is chosen, read/resize to data URL and save to Firestore
logoFile.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  try {
    const dataUrl = await fileToDataUrl(file, {
      maxW: 360,     // cap width so the data URL stays small
      maxH: 120,     // header-height friendly
      quality: 0.9   // jpeg quality if we encode to jpeg
    });

    await setSharedDoc('logoUrl', dataUrl); // triggers onSnapshot -> renderLogo()
  } catch (err) {
    console.error(err);
    alert('Could not read that image. Try a PNG or JPG.');
  } finally {
    // Reset the input so picking the same file again still fires 'change'
    logoFile.value = '';
  }
});

// Utility: read & (optionally) resize the image to a data URL
function fileToDataUrl(file, { maxW = 360, maxH = 120, quality = 0.9 } = {}) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error('File read failed'));
    reader.onload = () => {
      const img = new Image();
      img.onerror = () => reject(new Error('Image decode failed'));
      img.onload = () => {
        // Calculate target size
        const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);

        // Draw into a canvas (resize if needed)
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        // Choose output format
        const wantPng = file.type.includes('png') || file.type.includes('svg');
        const mime = wantPng ? 'image/png' : 'image/jpeg';
        const out = canvas.toDataURL(mime, quality);

        resolve(out);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}
    function renderAll(){
      renderHeaderControls();
      (view==="agenda"? (agendaList.classList.remove("hidden"), hourlyGrid.classList.add("hidden"), renderAgenda())
                      : (hourlyGrid.classList.remove("hidden"), agendaList.classList.add("hidden"), renderHourly()));
      renderDetails();
      renderTravel();
      renderGpt();
        renderLogo();  
      renderImportExport();
      
    }

    // INITIAL LOAD from Firestore + realtime subscriptions
    (async function init(){
  // One-time simple settings
  gptUrl  = (await getSharedDoc('gptUrl',  "")) || "";
  logoUrl = (await getSharedDoc('logoUrl', "")) || "";
  renderGpt(); renderLogo();

  // Live settings
  onSharedDoc('gptUrl',  v => { gptUrl  = v || ""; renderGpt(); });
  onSharedDoc('logoUrl', v => { logoUrl = v || ""; renderLogo(); });

  // Realtime meetings (subcollection)
  MEETINGS.orderBy('startISO').onSnapshot(async snap => {
    if (snap.empty) {
      // Optional seed once on first run
      const batch = db.batch();
      SAMPLE_MEETINGS.forEach(m => batch.set(MEETINGS.doc(m.id), m));
      await batch.commit();
      return;
    }
    meetings = snap.docs.map(d => d.data());
 const mDays = daysFromCalendar();
 if (mDays.length && !mDays.some(d => sameDay(d, activeDate))) activeDate = mDays[0];
 renderAll();
  });
// Realtime travel (subcollection)
  TRAVEL.orderBy('startISO').onSnapshot(async snap => {
    if (snap.empty) {
      const batch = db.batch();
      SAMPLE_TRAVEL.forEach(t => batch.set(TRAVEL.doc(t.id), t));
      await batch.commit();
      return;
    }
    travel = snap.docs.map(d => d.data());
    renderTravel();
  });

  renderAll(); // first paint
})();
})();
  </script>
</body>
</html>
