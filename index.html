<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tradeshow Meetings Assistant — Realtime</title>
  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --border:#e5e7eb;
      --primary:#111827;
      --primary-50:#f3f4f6;
      --blue:#1d4ed8;
      --shadow:0 1px 2px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.1);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .container{padding:24px;max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    h1{font-size:22px;margin:0;display:flex;gap:8px;align-items:center}
    .grid{display:grid;gap:24px}
    @media(min-width:1024px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-h{padding:16px 16px 8px 16px;border-bottom:1px solid var(--border)}
    .card-h .title{font-weight:700;display:flex;gap:8px;align-items:center}
    .card-h .desc{font-size:12px;color:var(--muted);margin-top:4px}
    .card-c{padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.icon{width:36px;height:36px;justify-content:center}
    .btn.sm{padding:6px 10px;font-size:12px}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;background:#fff}
    .item-c{padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .item .title{font-size:13px;font-weight:600}
    .item .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:38vw}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input, textarea, select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    textarea{min-height:70px}
    .kicker{font-size:12px;font-weight:700;margin:8px 0}
    .attendee{border:1px solid var(--border);border-radius:12px;padding:10px}
    .avatar{width:44px;height:44px;border-radius:999px;background:#eee;display:inline-flex;align-items:center;justify-content:center}
    .hour-grid{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .hour-row{display:grid;grid-template-columns:110px 1fr;border-bottom:1px solid var(--border)}
    .hour-row:last-child{border-bottom:none}
    .hour-label{padding:8px 12px;text-align:right;color:var(--muted);font-size:12px}
    .hour-cell{padding:8px 12px}
    .ghost{height:24px;border-radius:8px;background:var(--primary-50)}
    .meeting-pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .tools{display:flex;gap:8px;align-items:center}
    .tabs{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .tab{padding:6px 10px;border:0;background:#fff;cursor:pointer}
    .tab.active{background:var(--primary);color:#fff}
    .spacer{height:8px}
    .hidden{display:none}
    .hr{height:1px;background:var(--border);margin:12px 0}
    dialog{border:none;border-radius:14px;width:min(720px,96vw);} dialog::backdrop{background:rgba(0,0,0,.35)}
    .dialog-c{padding:16px} .dialog-actions{display:flex;justify-content:flex-end;gap:8px;padding:0 16px 16px}
    .link{color:var(--blue);text-decoration:underline}
    .flex{display:flex}.gap8{gap:8px}.gap12{gap:12px}.gap16{gap:16px}.col{display:flex;flex-direction:column}.wfull{width:100%}.end{justify-content:flex-end}
    .ae{border:1px solid var(--border);border-radius:12px;padding:10px}
.ae-grid{display:grid;grid-template-columns:56px 1fr;gap:12px;align-items:flex-start}
.ae-avatar{width:44px;height:44px;border-radius:999px;background:#eee;display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700}
.ae-avatar img{width:44px;height:44px;object-fit:cover;border-radius:999px}
.ae-two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ae-actions{display:flex;justify-content:flex-end;margin-top:8px}
    .ae-linkwrap{display:flex;gap:8px;align-items:center}
    .meeting-pill { /* existing */ }
.item.session{
  border-left: 4px solid var(--session-accent);
  background: #fff;}
.item.session .title{ color: var(--text); }
.item.meeting{
  border-left: 4px solid var(--meeting-accent);
  background:#fff;
}
.item.meeting .title{ color: var(--text); }
/* Hourly pills: colored outline + subtle fill of the same hue (not pale gray) */
  .item.session.afterhours{
  border-left-color: var(--afterhours-accent);
}
  
.meeting-pill.session{
  border:1px solid var(--session-accent);
  background: var(--session-accent);
  color:#111827; /* black text */
}
.meeting-pill.session .muted{ color: rgba(17,24,39,.8); }

/* Meeting pills: dark orange fill, white text */
.meeting-pill.meeting{
  border:1px solid var(--meeting-accent);
  background: var(--meeting-accent);
  color:#fff;
}
.meeting-pill.meeting .muted{ color: rgba(255,255,255,.85); }
    /* === Blue background + interactive polish === */
    .meeting-pill.session.afterhours{
  border: 1px solid var(--afterhours-accent);
  background: var(--afterhours-accent);
  color: #111827;               /* readable dark text */
}
.meeting-pill.session.afterhours .muted{
  color: rgba(17,24,39,.8);
}
:root{
  --bg:#1d4ed8;          /* page background */
  --card:#ffffff;        /* cards/boxes stay white */
  --primary:#1d4ed8;     /* brand/accents */
  --primary-50:#eff6ff;  /* pale blue for subtle fills */
  --blue:#1d4ed8;
  --shadow-hover:0 6px 12px rgba(0,0,0,.18);
 
}

/* Make header text readable on blue */
header h1,
header .muted { color:#fff; }
header .muted { opacity:.9; }
.head-left{ display:flex; align-items:center; gap:12px; }

/* Make the logo align well with the text */
h1{
  display:flex;
  align-items:center;
  gap:10px;
  margin:0;
}

.brand-logo{
  height:24px;     /* tweak to taste (20–28px usually looks good) */
  width:auto;
  object-fit:contain;
  border-radius:6px; /* optional */
}


/* Hover lift for cards and list items */
.card{
  transition: box-shadow .25s ease, transform .2s ease;
}
.card:hover{
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}
.item{
  transition: box-shadow .25s ease, transform .2s ease;
}
.item:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

/* Slightly brighter active tab/button on hover */
.tab.active:hover{
  filter: brightness(1.05);
}
.btn.primary{
  transition: transform .15s ease, box-shadow .2s ease, filter .15s ease;
}
.btn.primary:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
  filter: brightness(1.05);
}

/* Optional: underline links a touch darker on hover */
.link:hover { filter: brightness(.95); }
    :root{
  --bg:#19a4d0;              /* page background */
  --card:#ffffff;            /* keep cards white */
  --text:#111827;            /* keep dark text (for inside cards) */
  --border:#e5e7eb;

  --primary:#19a4d0;         /* primary brand blue */
  --primary-hover:#148fb6;   /* a bit darker for hover/focus */
  --primary-50:#e8f7fc;      /* very light tint for subtle fills */
  --blue:#19a4d0;            /* link color */
  
  --session-accent:#FDBA74;   /* light orange for sessions */
  --meeting-accent:#EA580C;   /* dark orange for meetings */
  --afterhours-accent:#bbf7d0; 
}

/* Make header text readable on the blue background */
header h1,
header .tools { color:#fff; }
header .muted { color:rgba(255,255,255,.85); }
header .tools .btn {
  color: var(--text);
  background:#fff;
  border-color: var(--border);
}
/* Optional: nicer hover for primary buttons & active tabs */
.btn.primary:hover{
  background:var(--primary-hover);
  border-color:var(--primary-hover);
}
.tab.active:hover{
  background:var(--primary-hover);
}
    .brand{display:flex;gap:10px;align-items:center}
.brand-logo{height:28px;width:auto;border-radius:6px;background:#fff;padding:2px;box-shadow:var(--shadow)}
.brand-logo.hidden{display:none}
    .head-left{
  display:flex;
  align-items:center;
  gap:12px;
}
.details-grid{
  display:grid;
  gap:16px;
  grid-template-columns: 1fr 2fr;
}
@media (max-width: 640px){
  .details-grid{
    grid-template-columns: 1fr;
  }
}

/* Reusable avatar image class (lets CSS control size responsively) */
.avatar-img{
  width:44px;
  height:44px;
  object-fit:cover;
  border-radius:999px;
}

/* Make attendee box + photos bigger on mobile */

  /* Editor dialog */
  .ae{ padding:12px; }
  .ae-avatar, .ae-avatar img{ width:64px; height:64px; }
  .ae-grid{ grid-template-columns:72px 1fr; }

  /* Let the LinkedIn button wrap under the name on narrow screens */
  .attendee .row{ flex-wrap:wrap; gap:12px; align-items:flex-start; }
  .attendee .link{ margin-left:72px; }
.brand-logo{
  height:32px;   /* tweak if you want it bigger/smaller */
  width:auto;
  object-fit:contain;
  border-radius:6px; /* optional little rounding */
}
/* Compact GPT card */
#gptCard { 
  margin-bottom: 16px;            /* space before Schedule/Agenda */
}
#gptCard .card-h { 
  padding: 10px 12px;             /* tighter header */
}
#gptCard .tools .btn,
#gptCard .btn.sm {
  padding: 4px 8px;               /* smaller buttons */
  font-size: 12px;
}
#gptCard .desc { 
  margin-top: 6px; 
}

/* If you previously centered the GPT card, undo it */
#gptCard { text-align: left; }
#gptCard .card-h .title { justify-content: flex-start; }
#gptCard .tools { justify-content: flex-start; }
    #gptCard { margin-bottom: 16px; }                /* space before Schedule/Agenda */
#gptCard .card-h { padding: 10px 12px; }         /* tighten vertical padding */

#gptCard .gpt-head {
  align-items: center;
  justify-content: space-between;                /* title left, buttons right */
  gap: 12px;
}

#gptCard .title {
  font-size: 20px;                               /* bigger title */
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: .2px;
}

#gptCard .tools { display: flex; gap: 8px; }
#gptCard .btn.sm { padding: 6px 10px; font-size: 13px; }

#gptCard .desc {
  margin-top: 6px;                               /* small, consistent hint */
  font-size: 12px;
  color: var(--muted);
}

/* If you previously centered GPT content, undo it to avoid odd spacing */
#gptCard, #gptCard .card-h, #gptCard .desc { text-align: left; }
    #gptCard .tools { gap: 10px; }

#gptCard .btn.sm {
  min-height: 40px;      /* taller button */
  padding: 8px 14px;     /* more breathing room */
  font-size: 14px;       /* slightly larger text */
  border-radius: 12px;   /* a touch more rounded */
}
  .attendee .avatar,
.attendee .avatar-img{
  width:72px;
  height:72px;
}

.attendee .name{
  font-size:16px;
  font-weight:700;
  line-height:1.2;
}

.attendee .role{
  font-size:14px;
  color: var(--muted);
}

/* Mobile: even larger */
@media (max-width: 640px){
  .attendee{ padding:16px; }
  .attendee .avatar,
  .attendee .avatar-img{ width:88px; height:88px; }
  .attendee .name{ font-size:18px; }
  .attendee .role{ font-size:15px; }

  /* keep the LinkedIn link aligned to the right of the bigger avatar */
  .attendee .link{ margin-left:96px; }
}
    #gptCard .title {
  font-size: 26px;      /* was 20px */
  line-height: 1.15;
}

/* Large primary button option */
.btn.lg {
  padding: 12px 18px;
  font-size: 16px;
  border-radius: 14px;
  min-height: 48px;
}
  #agendaList .item {
  border-radius: 14px;
  box-shadow: var(--shadow);            /* same subtle lift everywhere */
  border-left-width: 4px;               /* keep the colored bar crisp */
}


#agendaList .item .title { line-height: 1.25; }
#agendaList .item .sub   { margin-top: 4px; white-space: normal; }

/* (already in your CSS, but restated for clarity) */
#agendaList .item.session { border-left-color: var(--session-accent); }
#agendaList .item.meeting { border-left-color: var(--meeting-accent); }
#agendaList .item.session.afterhours { border-left-color: var(--afterhours-accent); }
    :root { --agenda-row-minh: 104px; }          /* tweak: 96–120px works well */

#agendaList .item .item-c {
  min-height: var(--agenda-row-minh);
  padding: 18px 20px;                         /* add a bit more vertical space */
  display: grid;
  grid-template-columns: 1fr auto;            /* text left, tools/chip right */
  align-items: center;
  gap: 14px;
}

/* nicer spacing in the text stack */
#agendaList .item .title { line-height: 1.3; }
#agendaList .item .sub   { margin-top: 6px; white-space: normal; }

/* Slightly shorter on small screens so it doesn’t feel oversized */
@media (max-width: 640px){
  :root { --agenda-row-minh: 88px; }
  #agendaList .item .item-c { padding: 16px 18px; }
}

/* (optional) only make sessions extra-long */
#agendaList .item.session .item-c { min-height: calc(var(--agenda-row-minh) + 8px); }
#agendaList .item .sub {
  white-space: normal;
  max-width: 100%;
}  
    #rowDateOnly.hidden { display:none; }
.chip input { margin-right:6px; }
    .item.meeting.clickable { cursor: pointer; }
.pulse { outline: 2px solid var(--blue); box-shadow: 0 0 0 4px var(--primary-50); transition: box-shadow .2s ease; }
    .top-tabs{
  display:flex; gap:8px; align-items:center; margin:12px 0 16px;
}
.top-tabs .tab{
  padding:8px 12px; border:1px solid var(--border); background:#fff; cursor:pointer;
  border-radius:999px; font-weight:600;
}
.top-tabs .tab.active{
  background:var(--primary); color:#fff; border-color:var(--primary);
}
    .msg{display:flex; gap:8px; margin:8px 0;}
.msg .who{font-weight:700; width:64px; flex:0 0 auto; color:var(--muted);}
.msg .bubble{background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; max-width:100%;}
.msg.assistant .bubble{ background: var(--primary-50); }

/* Hide the long body only in the Schedule view's right column.
   The Meetings tab (detailsStandalone) will show full details. */
#view-schedule #detailsCol .card .card-c {
  display: none;
}
    /* --- Make GPT chat area white --- */
#view-gpt {
  background-color: #ffffff !important; /* white background */
  color: #000; /* ensure readable text */
}

#gptPanel {
  background-color: #ffffff !important;
  box-shadow: none;
}

/* Chat window */
#chatWindow {
  background-color: #ffffff !important;
  border: 1px solid #ddd;
  color: #000;
}

/* Chat input and button area */
#gptForm {
  background-color: #ffffff;
}

/* Optional: give the overall card a soft border for separation */
#view-gpt .card {
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  background-color: #ffffff;
}
    /* Header: 3-column grid — tabs | centered title/logo | utilities  */
header{
  display:grid;
  grid-template-columns:auto 1fr auto;
  align-items:center;
  gap:16px;
}

/* left column (tabs) stays left */
#topTabs{ justify-self:start; }

/* center column (logo + title) */
.head-left{
  justify-self:center;
  text-align:center;
}

/* make the H1 content itself centered horizontally */
.head-left h1{
  justify-content:center;   /* center the logo + text row */
}

/* right column (import/export buttons) stays right */
header .tools{ justify-self:end; }

/* keep header text readable on the blue background */
header h1, header .muted { color:#fff; }

/* One rounded container for the whole chat area */
#chatShell{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;            /* ← the rounded edges you want */
  overflow:hidden;               /* keeps inner corners clean */
  box-shadow: var(--shadow);     /* optional: subtle lift */
}
#chatForm{
  background:#fff;
  padding:12px;
}

/* Optional: make input/buttons rounded to match */
#chatInput{ border-radius:10px; }
#chatSend{ border-radius:10px; }


/* Round the chat area and input for cohesive style */
#view-gpt #chatWindow {
  border-radius: 20px;
}

#view-gpt #chatForm input {
  border-radius: 20px;
}

#view-gpt #chatForm .btn {
  border-radius: 20px;
  }
    /* Hide Travel tab + view */
#topTabs .tab[data-toptab="travel"] { display: none !important; }
#view-travel { display: none !important; }
    /* optional: smaller contact chips in attendee cards */
.attendee .chip {
  padding: 4px 8px;
  font-size: 12px;
}

  </style>

  <!-- Firebase compat SDKs (no build step) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>


<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAefJL7N3PBdQeGJWwjJZjfEQC8qUcpT5U",
    authDomain: "tradeshow-assistant.firebaseapp.com",
    projectId: "tradeshow-assistant",
    storageBucket: "tradeshow-assistant.appspot.com", // typical format
    messagingSenderId: "865900601935",
    appId: "1:865900601935:web:82a7b49e70f8088d40003a"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const db = firebase.firestore();
  const COL = db.collection('tradeshow');

  async function getSharedDoc(docId, fallback) {
    const snap = await COL.doc(docId).get();
    return snap.exists ? snap.data().value : fallback;
  }
  async function setSharedDoc(docId, value) {
    return COL.doc(docId).set({ value }, { merge: true });
  }
  function onSharedDoc(docId, cb) {
    return COL.doc(docId).onSnapshot(s => { if (s.exists) cb(s.data().value); });
  }
</script>
</head>
<body>
  <div class="container">
  <header>
    <div id="topTabs" class="top-tabs">
  <button class="tab" data-toptab="gpt">🤖 GPT</button>
        <button class="tab" data-toptab="meetings">🧑‍🤝‍🧑 Meetings</button>
  <button class="tab" data-toptab="schedule">📆 Schedule</button>
  <button class="tab" data-toptab="travel">✈️ Travel</button>
      
</div>
  <div class="head-left">
    <h1>
      <!-- Logo replaces the emoji -->
      <img id="brandLogo" class="brand-logo hidden" alt="Company logo" />
      <label for="logoFile" id="setLogoBtn" class="btn sm">🖼️ Set logo</label>
      <button class="btn sm" id="setLogoUrlBtn" type="button">🔗 Set logo URL</button>
<input id="logoFile" type="file" accept="image/*" style="position:absolute;left:-9999px;width:1px;height:1px;" />
  Your Dreamforce 2025 Assistant
  <span class="muted" style="font-weight:400"></span>
</h1>
      
  </div>
  <div class="tools">
    <div id="importExport"></div>
  </div>
</header>
<section id="view-gpt">
  <div id="gptPanel" class="card">
    <div class="card-h">
      <div class="title">🤖 Ask Our GPT</div>
         <div class="tools">
          <button class="btn sm" id="openGptBtn" title="Open your personal GPT">🔗 Open our GPT</button>
        </div>
      </div>
  </div> 
</section>
<section id="view-meetings" class="hidden">
  <div class="card">
    <div class="card-h">
      <div class="row">
        <div class="title">🧑‍🤝‍🧑 Meeting details</div>
        <div class="tools">
          <button class="btn primary sm" id="mtabAddMeeting">➕ Add meeting</button>
        </div>
      </div>
      <div class="desc">All upcoming meetings (Date-TBD first).</div>
    </div>
    <div class="card-c">
      <div class="col gap16" id="detailsStandalone"></div>
    </div>
  </div>
</section>
<section id="view-travel" class="hidden">
  <div id="travelCard" class="card">
    <div class="card-h">
      <div class="row">
        <div class="title">✈️ Travel</div>
        <button id="travelCollapseBtn" class="btn icon" aria-expanded="true" title="Collapse/expand">▾</button>
      </div>
      <div class="desc">Store flight, hotel, and ground confirmations.</div>
    </div>
    <div class="card-c" id="travelSection"></div>
  </div>
</section>
    <section id="view-schedule">
    <div class="grid">
      <!-- Left -->
      <div class="col gap16">
        <div class="card">
          <div class="card-h">
            <div class="title">📆 Schedule</div>
            <div class="desc">Switch between an agenda and an hourly grid for any show day.</div>
          </div>
          <div class="card-c">
            <!-- Dreamforce Sessions Agenda link -->
<div style="margin-bottom:10px">
  <a id="dfAgendaLink"
     href="https://www.salesforce.com/dreamforce/sessions/"
     target="_blank" rel="noopener"
     class="link"
     style="font-weight:600; text-decoration:underline;">
    🔗 View the full Dreamforce Sessions Agenda
  </a>
</div>
            <div class="row">
              <div class="tools">
                <button class="btn icon" id="prevDay" title="Previous day">◀</button>
                <div id="activeDateLbl" style="font-weight:600"></div>
                <button class="btn icon" id="nextDay" title="Next day">▶</button>
              </div>
              <div class="tabs">
                <button class="tab active" id="tabAgenda">Agenda</button>
                <button class="tab" id="tabHourly">Hourly</button>
              </div>
            </div>

            <div id="agendaList" class="list" style="margin-top:12px"></div>
            <div id="hourlyGrid" class="hidden" style="margin-top:12px"></div>

            <div class="spacer"></div>
            <button id="addMeetingBtn" class="btn primary wfull">➕ Add meeting</button>
          </div>
        </div>

    
        
      <!-- Right -->
      <div class="col gap16" id="detailsCol"></div>
       </div> <!-- end .grid -->
</section>

  <!-- Dialogs -->
  <dialog id="logoDialog">
  <div class="dialog-c">
    <h3 style="margin:0 0 8px 0">Set logo URL</h3>
    <div class="col gap12">
      <input id="logoInput" placeholder="https://example.com/logo.png" />
      <div class="muted" style="font-size:12px">
        Tip: use a transparent PNG or SVG if you have one.
      </div>
    </div>
  </div>
  <div class="dialog-actions">
    <button class="btn" id="logoCancel">Cancel</button>
    <button class="btn primary" id="logoSave">Save</button>
  </div>
</dialog>
<dialog id="meetingDialog">
  <div class="dialog-c">
    <h3 id="dlgTitle" style="margin:0 0 8px 0">New meeting</h3>
    <div class="col gap12">
      <input id="m_title" placeholder="Title" />
      <div class="two">
        <input id="m_location" placeholder="Location" />
        <input id="m_booth" placeholder="Booth" />
      </div>
      
    <div class="two" id="rowDateTimes">
  <input id="m_start" type="datetime-local" />
  <input id="m_end"   type="datetime-local" />
</div>
  
      <div class="two">
  <label class="chip"><input id="m_dateTBD" type="checkbox"> Date TBD</label>
  <label class="chip"><input id="m_timeTBD" type="checkbox"> Time TBD</label>
</div>

<!-- NEW: date-only when time is TBD -->
<div class="two hidden" id="rowDateOnly">
  <input id="m_dateOnly" type="date" />
  <div></div>
</div>
      <textarea id="m_desc" placeholder="Description / goals"></textarea>

      <div class="kicker">Attendees</div>
      <div id="attendeeEditor" class="col gap12"></div>
      <div class="ae-actions">
        <button type="button" class="btn sm" id="addAttendeeBtn">➕ Add attendee</button>
      </div>
    </div>
  </div>
  <div class="dialog-actions">
    <button class="btn" id="dlgCancel">Cancel</button>
    <button class="btn primary" id="dlgSave">Save</button>
  </div>
</dialog>


  <dialog id="gptDialog">
    <div class="dialog-c">
      <h3 style="margin:0 0 8px 0">Set your GPT link</h3>
      <div class="col gap12">
        <input id="gptInput" placeholder="https://chat.openai.com/g/g-XXXXX-your-gpt"/>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="gptCancel">Cancel</button>
      <button class="btn primary" id="gptSave">Save</button>
    </div>
  </dialog>

  <dialog id="travelDialog">
    <div class="dialog-c">
      <h3 style="margin:0 0 8px 0">New travel</h3>
      <div class="col gap12">
        <div class="two">
          <select id="t_type">
            <option value="flight">Flight</option>
            <option value="hotel">Hotel</option>
            <option value="ground">Ground</option>
          </select>
          <input id="t_label" placeholder="Label (e.g., ATL → BOS)" />
        </div>
        <div class="two">
          <input id="t_conf" placeholder="Confirmation #" />
          <input id="t_details" placeholder="Details" />
        </div>
        <div class="two" id="t_rowDateTime">
          <input id="t_start" type="datetime-local" />
          <input id="t_end" type="datetime-local" />
          </div>

<!-- Show only for hotels -->
<div class="two hidden" id="t_rowDateOnly">
  <input id="t_startDate" type="date" />
  <input id="t_endDate"   type="date" />
</div>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn" id="t_cancel">Cancel</button>
      <button class="btn primary" id="t_save">Save</button>
    </div>
  </dialog>

 <script>
(function () {
  // ========= Utilities =========
  const $  = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  const uid = () => Math.random().toString(36).slice(2, 9);

  // NOTE: App timezone is PT; change as needed
  const TZ = 'America/Los_Angeles';
  const TBD_ANCHOR_YMD = '2025-09-02'; // day that hosts Date-TBD group

  const fmtTime = (iso) =>
    new Date(iso).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", timeZone: TZ, hour12: true });

  const fmtDate = (iso) =>
    new Date(iso).toLocaleDateString([], { year: "numeric", month: "short", day: "2-digit", timeZone: TZ });

  const ptMinutes = (iso) => {
    const parts = new Intl.DateTimeFormat('en-US', { timeZone: TZ, hour: '2-digit', minute: '2-digit', hour12: false })
      .formatToParts(new Date(iso));
    const h = +parts.find(p => p.type === 'hour').value;
    const m = +parts.find(p => p.type === 'minute').value;
    return h * 60 + m;
  };

  const ymdPartsInTZ = (iso) =>
    new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' })
      .formatToParts(new Date(iso))
      .reduce((o, p) => (p.type !== 'literal' && (o[p.type] = p.value), o), {});

  const ymdInTZ = (iso) => {
    const parts = ymdPartsInTZ(iso);
    return `${parts.year}-${parts.month}-${parts.day}`;
  };

  const sameDay = (aISO, bISO) => {
    const A = ymdPartsInTZ(aISO), B = ymdPartsInTZ(bISO);
    return A.year === B.year && A.month === B.month && A.day === B.day;
  };

  const isSameOrAfterTodayInTZ = (iso) => ymdInTZ(iso) >= ymdInTZ(new Date().toISOString());
  const isAnchorDay = (iso) => ymdInTZ(iso) === TBD_ANCHOR_YMD;

  const escapeHtml = (s) =>
    (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

  const parseBullets = (text) => {
    if (!text) return [];
    return text
      .split(/\r?\n/)
      .map(s => s.replace(/^\s*([•*-])\s+/, '').trim())
      .filter(Boolean);
  };

  const renderNotes = (text) => {
    const items = parseBullets(text);
    if (items.length >= 2 || /^(\s*[•*-]\s+)/.test(text || "")) {
      const ul = document.createElement('ul');
      ul.style.margin = '0';
      ul.style.paddingLeft = '18px';
      items.forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        ul.append(li);
      });
      return ul;
    } else {
      const p = document.createElement('p');
      p.textContent = (text || '').trim();
      return p;
    }
  };

  const displayLocation = (it) => {
    if (!it || typeof it !== 'object') return '';
    const keys = [
      'location','Location',
      'stage','Stage',
      'stageName','stage_name','StageName',
      'venue','Venue',
      'room','Room',
      'place','Place',
      'where','Where',
      'locationNote','location_name','LocationName','LocationNote',
      'space','Space','area','Area'
    ];
    const pickString = (v) => {
      if (typeof v === 'string') return v.trim();
      if (Array.isArray(v)) {
        return v.map(x => (typeof x === 'string' ? x.trim()
          : x && typeof x === 'object' ? (x.name || x.label || '').trim()
          : ''))
          .filter(Boolean).join(' • ');
      }
      if (v && typeof v === 'object') return (v.name || v.label || v.location || '').toString().trim();
      return '';
    };
    for (const k of keys) {
      if (k in it) {
        const s = pickString(it[k]);
        if (s) return s;
      }
    }
    return '';
  };

  const nowInTZISO = () => {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).formatToParts(new Date())
      .reduce((o, p) => (p.type !== 'literal' && (o[p.type] = p.value), o), {});
    return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`;
  };

  const pickMostCurrentDay = (days) => {
    if (!days || !days.length) return null;
    const todayYmd = ymdInTZ(new Date().toISOString());
    for (const d of days) if (ymdInTZ(d) >= todayYmd) return d;
    return days[days.length - 1];
  };

  const sanitizeUrl = (u) => {
    if (!u) return "";
    let s = u.trim();
    if (!/^https?:\/\//i.test(s)) s = "https://" + s;
    return s;
  };

  // ========= Firestore refs (provided by your app env) =========
  // These must exist in the page scope: db, COL, onSharedDoc, getSharedDoc, setSharedDoc
  const MEETINGS = COL.doc('meetings').collection('items');
  const TRAVEL   = COL.doc('travel').collection('items');
  const SESSIONS = COL.doc('sessions').collection('items');

  const upsertMeeting = (m) => {
    const id = m.id || uid();
    return MEETINGS.doc(id).set({ ...m, id }, { merge: true });
  };
  const deleteMeeting = (id) => MEETINGS.doc(id).delete();

  const upsertTravel = (t) => {
    const id = t.id || uid();
    return TRAVEL.doc(id).set({ ...t, id }, { merge: true });
  };
  const deleteTravel = (id) => TRAVEL.doc(id).delete();

  const upsertSession = (s) => {
    const id = s.id || uid();
    return SESSIONS.doc(id).set({ ...s, id }, { merge: true });
  };
  const deleteSession = (id) => SESSIONS.doc(id).delete();

  // ========= State =========
  let gptUrl   = "";
  let logoUrl  = "";
  let meetings = [];
  let sessions = [];
  let travel   = [];
  let activeDate = new Date().toISOString();
  let view = "agenda";
  let autoPickedDayOnce = false;

  const TOP_TABS = ["schedule", "travel", "gpt", "meetings"];
  let activeTopTab = localStorage.getItem("activeTopTab") || "gpt";
if (activeTopTab === 'travel') activeTopTab = 'gpt';
  // ========= Elements =========
  const activeDateLbl = $("#activeDateLbl");
  const prevDayBtn = $("#prevDay");
  const nextDayBtn = $("#nextDay");
  const tabAgenda  = $("#tabAgenda");
  const tabHourly  = $("#tabHourly");
  const agendaList = $("#agendaList");
  const hourlyGrid = $("#hourlyGrid");
  const addMeetingBtn = $("#addMeetingBtn");
  const detailsCol = $("#detailsCol");

  const travelSection  = $("#travelSection");
  const travelCollapseBtn = $("#travelCollapseBtn");

  // Meeting dialog
  const meetingDialog = $("#meetingDialog");
  const dlgTitle = $("#dlgTitle");
  const dlgSave  = $("#dlgSave");
  const dlgCancel= $("#dlgCancel");
  const m_title  = $("#m_title");
  const m_location = $("#m_location");
  const m_booth  = $("#m_booth");
  const m_start  = $("#m_start");
  const m_end    = $("#m_end");
  const m_desc   = $("#m_desc");
  const m_dateTBD = $("#m_dateTBD");
  const m_timeTBD = $("#m_timeTBD");
  const rowDateTimes = $("#rowDateTimes");
  const rowDateOnly  = $("#rowDateOnly");
  const m_dateOnly   = $("#m_dateOnly");

  // Attendees editor
  const attendeeEditorRoot = $("#attendeeEditor");
  const addAttendeeBtn = $("#addAttendeeBtn");
  let currentAttendees = [];
  const blankAttendee = () => ({ id: uid(), name: "", title: "", company: "", linkedin: "", photoUrl: "", notes: "", email: "", phone: "" });

  // Travel dialog
  const travelDialog = $("#travelDialog");
  const t_type   = $("#t_type");
  const t_label  = $("#t_label");
  const t_conf   = $("#t_conf");
  const t_details= $("#t_details");
  const t_start  = $("#t_start");
  const t_end    = $("#t_end");
  const t_startDate = $("#t_startDate");
  const t_endDate   = $("#t_endDate");
  const t_rowDateTime = $("#t_rowDateTime");
  const t_rowDateOnly = $("#t_rowDateOnly");
  const t_save   = $("#t_save");
  const t_cancel = $("#t_cancel");

  // Logo + personal GPT
const brandLogo   = $("#brandLogo");
const setLogoBtn  = $("#setLogoBtn");                 // ← add back

  const logoDialog = $("#logoDialog");
  const logoInput  = $("#logoInput");
  const logoSave   = $("#logoSave");
  const logoCancel = $("#logoCancel");
  const logoFile   = $("#logoFile");
  const openGptBtn = $("#openGptBtn");
  const gptDialog  = $("#gptDialog");
  const gptInput   = $("#gptInput");
  const gptSave    = $("#gptSave");
  const gptCancel  = $("#gptCancel");

  // Assistant chat (frontend only)
  const chatWindow = $("#chatWindow");
  const chatForm   = $("#chatForm");
  const chatInput  = $("#chatInput");
  const chatSend   = $("#chatSend");

  // ========= Helpers (UI/DOM) =========
  function updateTravelDateInputs() {
    const isHotel = (t_type.value === "hotel");
    t_rowDateTime.classList.toggle("hidden", isHotel);
    t_rowDateOnly.classList.toggle("hidden", !isHotel);
  }

  function fileToDataUrl(file, { maxW = 360, maxH = 120, quality = 0.9 } = {}) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error('File read failed'));
      reader.onload = () => {
        const img = new Image();
        img.onerror = () => reject(new Error('Image decode failed'));
        img.onload = () => {
          const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
          const w = Math.round(img.width * ratio);
          const h = Math.round(img.height * ratio);
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          const wantPng = file.type.includes('png') || file.type.includes('svg');
          const mime = wantPng ? 'image/png' : 'image/jpeg';
          resolve(canvas.toDataURL(mime, quality));
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  function setTravelCollapsed(collapsed, persist = true) {
    travelSection.classList.toggle("hidden", collapsed);
    travelCollapseBtn.setAttribute("aria-expanded", String(!collapsed));
    travelCollapseBtn.textContent = collapsed ? "▸" : "▾";
    if (persist) localStorage.setItem("travelCollapsed", collapsed ? "1" : "0");
  }

  function daysFromCalendar() {
    const byDay = new Map();
    // include meetings with known date + all sessions
    [...meetings.filter(m => !m.dateTBD), ...sessions].forEach(x => {
      const key = ymdInTZ(x.startISO);
      const cur = byDay.get(key);
      if (!cur || new Date(x.startISO) < new Date(cur)) byDay.set(key, x.startISO);
    });
    // ensure anchor day if there are any Date-TBD meetings
    if (meetings.some(m => m.dateTBD) && !byDay.has(TBD_ANCHOR_YMD)) {
      byDay.set(TBD_ANCHOR_YMD, new Date('2025-09-02T12:00:00Z').toISOString());
    }
    return Array.from(byDay.values()).sort((a, b) => new Date(a) - new Date(b));
  }

  function shiftDay(dir) {
    const days = daysFromCalendar();
    const idx = days.findIndex(d => sameDay(d, activeDate));
    const next = days[idx + dir];
    if (next) activeDate = next;
    renderAll();
  }

  function renderHeaderControls() {
    activeDateLbl.textContent = fmtDate(activeDate);
    tabAgenda.classList.toggle("active", view === "agenda");
    tabHourly.classList.toggle("active", view === "hourly");
  }

  function itemsForDay(iso) {
    const m = meetings.filter(x => sameDay(x.startISO, iso)).map(x => ({ ...x, kind: 'meeting' }));
    const s = sessions.filter(x => sameDay(x.startISO, iso)).map(x => ({ ...x, kind: 'session' }));
    return [...m, ...s].sort((a, b) => new Date(a.startISO) - new Date(b.startISO));
  }

  function focusMeetingInDetails(id) {
    const el = document.getElementById(`detail-${id}`);
    if (!el) return;
    el.scrollIntoView({ behavior: "smooth", block: "start" });
    el.classList.add("pulse");
    setTimeout(() => el.classList.remove("pulse"), 1200);
  }

  function appendMsg(role, text) {
    const row = document.createElement("div");
    row.className = `msg ${role}`;
    row.innerHTML = `<div class="who">${role === "user" ? "You" : "Assistant"}</div>
                     <div class="bubble">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`;
    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // ========= Renderers =========
  function renderAgenda() {
    agendaList.innerHTML = "";

    // Unscheduled on anchor day
    const unscheduled = meetings.filter(m => m.dateTBD);
    if (isAnchorDay(activeDate) && unscheduled.length) {
      const hdr = document.createElement("div");
      hdr.className = "kicker";
      hdr.textContent = "Unscheduled (TBD date)";
      agendaList.append(hdr);

      unscheduled.forEach(m => {
        const card = document.createElement("div");
        card.className = "item meeting clickable";
        const c = document.createElement("div"); c.className = "item-c";
        const left = document.createElement("div");

        const title = document.createElement("div"); title.className = "title";
        title.textContent = `TBD • ${m.title}`;

        const sub = document.createElement("div"); sub.className = "sub";
        const loc = displayLocation(m);
        const booth = m.booth ? `Booth ${m.booth}` : "";
        sub.textContent = [loc, booth].filter(Boolean).join(" • ");

        left.append(title, sub);

        const tools = document.createElement("div"); tools.className = "tools";
        const edit = document.createElement("button"); edit.className = "btn sm"; edit.textContent = "✏️";
        edit.onclick = (e) => { e.stopPropagation(); openMeetingDialog(m); };
        const del = document.createElement("button"); del.className = "btn sm"; del.textContent = "🗑️";
        del.onclick = async (e) => {
          e.stopPropagation();
          if (!confirm("Delete this meeting?")) return;
          try { await deleteMeeting(m.id); } catch (e) { console.error(e); alert("Delete failed: " + (e.code || e.message)); }
        };
        tools.append(edit, del);

        c.append(left, tools);
        card.append(c);
        card.addEventListener("click", () => focusMeetingInDetails(m.id));
        agendaList.append(card);
      });

      agendaList.append(Object.assign(document.createElement("div"), { className: "spacer" }));
    }

    // Scheduled items for active date
    const items = itemsForDay(activeDate);
    if (!items.length) {
      const div = document.createElement("div");
      div.className = "muted";
      div.textContent = "No scheduled items for this date.";
      agendaList.append(div);
      return;
    }

    items.forEach(it => {
      const card = document.createElement("div");
      card.className = "item";
      if (it.kind === 'session') card.classList.add('session');
      else if (it.kind === 'meeting') card.classList.add('meeting');
      if (it.kind === 'session' && (it.afterHours || it.category === 'afterHours')) card.classList.add('afterhours');

      const c = document.createElement("div"); c.className = "item-c";
      const left = document.createElement("div");
      const title = document.createElement("div"); title.className = "title";
      const tLabel = (it.dateTBD || it.timeTBD) ? "TBD" : `${fmtTime(it.startISO)}–${fmtTime(it.endISO)}`;
      title.textContent = `${tLabel} • ${it.title}`;

      const sub = document.createElement("div"); sub.className = "sub";
      const loc = displayLocation(it);
      const booth = it.booth ? `Booth ${it.booth}` : "";
      sub.textContent = [loc, booth].filter(Boolean).join(" • ");
      left.append(title, sub);

      const tools = document.createElement("div"); tools.className = "tools";
      if (it.kind === 'meeting') {
        const edit = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "✏️" });
        edit.onclick = (e) => { e.stopPropagation(); openMeetingDialog(it); };
        const del = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "🗑️" });
        del.onclick = async (e) => {
          e.stopPropagation();
          if (!confirm("Delete this meeting?")) return;
          try { await deleteMeeting(it.id); } catch (e) { console.error(e); alert("Delete failed: " + (e.code || e.message)); }
        };
        tools.append(edit, del);
      } else {
        const chip = document.createElement("span"); chip.className = "chip"; chip.textContent = "SESSION";
        tools.append(chip);
      }

      c.append(left, tools);
      card.append(c);

      if (it.kind === 'meeting') {
        card.classList.add('clickable');
        card.addEventListener('click', () => focusMeetingInDetails(it.id));
      }

      agendaList.append(card);
    });
  }

  function renderHourly() {
    hourlyGrid.innerHTML = "";
    const items = itemsForDay(activeDate);
    const wrap = document.createElement("div"); wrap.className = "hour-grid";

    // Time-TBD pills for this date
    const tbdToday = meetings.filter(m => !m.dateTBD && m.timeTBD && sameDay(m.startISO, activeDate));
    if (tbdToday.length) {
      const row = document.createElement("div"); row.className = "hour-row";
      const lbl = document.createElement("div"); lbl.className = "hour-label"; lbl.textContent = "TBD";
      const cell = document.createElement("div"); cell.className = "hour-cell";
      const box = document.createElement("div");
      box.style.display = "flex"; box.style.flexWrap = "wrap"; box.style.gap = "8px";
      tbdToday.forEach(it => {
        const pill = document.createElement("span");
        pill.className = "meeting-pill meeting";
        pill.style.cursor = "pointer";
        pill.addEventListener("click", () => focusMeetingInDetails(it.id));
        const loc = displayLocation(it);
        pill.innerHTML = `<strong>${escapeHtml(it.title)}</strong> <span class="muted">${loc ? `TBD • ${escapeHtml(loc)}` : "TBD"}</span>`;
        box.append(pill);
      });
      cell.append(box); row.append(lbl, cell); wrap.append(row);
    }

    // Hour rows
    const startHour = 7, hoursToShow = 17; // 7am–11pm
    const labelFromHour = (hr) => `${(((hr + 11) % 12) + 1).toString().padStart(2, "0")}:00 ${hr < 12 ? "AM" : "PM"}`;

    for (let i = 0; i < hoursToShow; i++) {
      const hr = startHour + i;
      const row = document.createElement("div"); row.className = "hour-row";
      const lbl = document.createElement("div"); lbl.className = "hour-label"; lbl.textContent = labelFromHour(hr);
      const cell = document.createElement("div"); cell.className = "hour-cell";

      const slot = items
        .filter(it => {
          if (it.dateTBD || it.timeTBD) return false;
          const s = ptMinutes(it.startISO);
          return Math.floor(s / 60) === hr;
        })
        .sort((a, b) => new Date(a.startISO) - new Date(b.startISO));

      if (!slot.length) {
        const g = document.createElement("div"); g.className = "ghost";
        cell.append(g);
      } else {
        const box = document.createElement("div");
        box.style.display = "flex"; box.style.flexWrap = "wrap"; box.style.gap = "8px";
        slot.forEach(it => {
          const pill = document.createElement("span");
          pill.className = "meeting-pill";
          if (it.kind === "session") pill.classList.add("session");
          else if (it.kind === "meeting") pill.classList.add("meeting");
          if (it.kind === "session" && (it.afterHours || it.category === "afterHours")) pill.classList.add("afterhours");
          if (it.kind === "meeting") {
            pill.style.cursor = "pointer";
            pill.addEventListener("click", () => focusMeetingInDetails(it.id));
          }
          const loc = displayLocation(it);
          const timeRange = `${fmtTime(it.startISO)}–${fmtTime(it.endISO)}`;
          const meta = loc ? `${timeRange} • ${escapeHtml(loc)}` : timeRange;
          pill.innerHTML = `<strong>${escapeHtml(it.title)}</strong> <span class="muted">${meta}</span>`;
          box.append(pill);
        });
        cell.append(box);
      }

      row.append(lbl, cell);
      wrap.append(row);
    }

    hourlyGrid.append(wrap);
  }

  function renderDetails(target = detailsCol, mode = "day") {
    target.innerHTML = "";
    const dayMeetings = (mode === "all")
      ? meetings
        .filter(m => m.dateTBD || isSameOrAfterTodayInTZ(m.startISO))
        .sort((a, b) => (a.dateTBD ? -1 : 0) - (b.dateTBD ? -1 : 0) || (new Date(a.startISO) - new Date(b.startISO)))
      : meetings
        .filter(m => sameDay(m.startISO, activeDate) || (m.dateTBD && isAnchorDay(activeDate)))
        .sort((a, b) => (a.dateTBD ? -1 : 0) - (b.dateTBD ? -1 : 0) || (new Date(a.startISO) - new Date(b.startISO)));

    if (!dayMeetings.length) {
      const card = document.createElement("div"); card.className = "card";
      card.innerHTML = `<div class="card-h"><div class="title">No meetings${mode === 'all' ? ' (upcoming)' : ''}</div></div>
                        <div class="card-c muted">Add one using the button on the left.</div>`;
      target.append(card);
      return;
    }

    dayMeetings.forEach(m => {
      const card = document.createElement("div"); card.className = "card"; card.id = `detail-${m.id}`;

      const head = document.createElement("div"); head.className = "card-h";

      const t = document.createElement("div"); t.className = "title row";
      const leftT = document.createElement("span"); leftT.textContent = m.title;
      const rightT = document.createElement("span"); rightT.className = "muted";
      let timePart;
      if (m.dateTBD) timePart = "TBD date";
      else if (m.timeTBD) timePart = "TBD time";
      else timePart = `${fmtTime(m.startISO)}–${fmtTime(m.endISO)}`;
      const dateLabel = m.dateTBD ? 'TBD' : fmtDate(m.startISO);
      rightT.textContent = `${dateLabel} • ${timePart}`;
      t.append(leftT, rightT);

      if (mode === "all") {
        const editHeadBtn = document.createElement("button");
        editHeadBtn.className = "btn sm"; editHeadBtn.textContent = "✏️ Edit"; editHeadBtn.title = "Edit meeting";
        editHeadBtn.onclick = (e) => { e.stopPropagation(); openMeetingDialog(m); };
        t.append(editHeadBtn);
      }
      head.append(t);

      const where = displayLocation(m);
      if (where) {
        const locLine = document.createElement("div");
        locLine.className = "desc";
        locLine.textContent = where;
        head.append(locLine);
      }

      const c = document.createElement("div"); c.className = "card-c";
      const inner = document.createElement("div"); inner.className = "details-grid";
      inner.style.gridTemplateColumns = "1fr 2fr"; inner.style.gap = "16px";

      // Right column: attendees
      const rightCol = document.createElement("div");
      const ak = document.createElement("div"); ak.className = "kicker"; ak.textContent = "Attendees";
      rightCol.append(ak);
      (m.attendees || []).forEach(a => {
        const wrap = document.createElement("div"); wrap.className = "attendee";
        const row = document.createElement("div"); row.className = "row";
        const who = document.createElement("div"); who.className = "row"; who.style.gap = "12px";
        const av = document.createElement("div"); av.className = "avatar";
        if (a.photoUrl) {
          const img = document.createElement("img"); img.src = a.photoUrl; img.alt = a.name || "Photo"; img.className = "avatar-img";
          av.append(img);
        } else {
          av.textContent = (a.name || "?").slice(0, 1).toUpperCase();
        }
        const meta = document.createElement("div");
        const nm = document.createElement("div"); nm.className = "name"; nm.textContent = a.name;
        const sub = document.createElement("div"); sub.className = "role"; sub.textContent = [a.title, a.company].filter(Boolean).join(" • ");
        meta.append(nm, sub);
        who.append(av, meta);

        const link = document.createElement("a"); link.className = "link"; link.textContent = "LinkedIn"; link.target = "_blank"; link.rel = "noreferrer";
        if (a.linkedin) link.href = a.linkedin; else { link.href = "#"; link.style.pointerEvents = "none"; link.style.opacity = ".5"; }

        row.append(who, link);
        wrap.append(row);

        if (a.notes) {
          const notes = document.createElement("div"); notes.style.marginTop = "6px"; notes.textContent = a.notes;
          wrap.append(notes);
        }

        const contact = document.createElement("div");
        contact.style.marginTop = "6px"; contact.style.display = "flex"; contact.style.gap = "8px"; contact.style.flexWrap = "wrap";
        if (a.email) {
          const emailLink = document.createElement("a"); emailLink.className = "chip"; emailLink.href = `mailto:${a.email}`; emailLink.textContent = a.email;
          contact.append(emailLink);
        }
        if (a.phone) {
          const phoneLink = document.createElement("a"); phoneLink.className = "chip";
          const tel = a.phone.replace(/[^\d+\-\s()]/g, "");
          phoneLink.href = `tel:${tel}`; phoneLink.textContent = a.phone;
          contact.append(phoneLink);
        }
        if (contact.children.length) wrap.append(contact);

        rightCol.append(wrap);
      });

      // Left column: description / points / prep
      const leftCol = document.createElement("div");
      if (m.description) leftCol.append(renderNotes(m.description));
      if (m.talkingPoints) {
        const k = document.createElement("div"); k.className = "kicker"; k.textContent = "Suggested talking points";
        const box = document.createElement("div"); box.style.background = "var(--primary-50)"; box.style.borderRadius = "12px"; box.style.padding = "12px";
        box.append(renderNotes(m.talkingPoints)); leftCol.append(k, box);
      }
      if (m.prepChecklist) {
        const k = document.createElement("div"); k.className = "kicker"; k.textContent = "Prep checklist";
        const box = document.createElement("div"); box.style.background = "var(--primary-50)"; box.style.borderRadius = "12px"; box.style.padding = "12px";
        box.append(renderNotes(m.prepChecklist)); leftCol.append(k, box);
      }
      const edit = document.createElement("button"); edit.className = "btn"; edit.textContent = "✏️ Edit details";
      edit.onclick = () => openMeetingDialog(m);
      leftCol.append(edit);

      inner.append(rightCol, leftCol);
      c.append(inner);
      card.append(head, c);
      target.append(card);
    });
  }

  function renderTravel() {
    const root = travelSection;
    root.innerHTML = "";

    const add = Object.assign(document.createElement("button"), { className: "btn", textContent: "➕ Add travel" });
    add.onclick = () => {
      t_type.value = "flight";
      t_label.value = ""; t_conf.value = ""; t_details.value = "";
      t_start.value = ""; t_end.value = "";
      t_startDate.value = ""; t_endDate.value = "";
      updateTravelDateInputs();
      travelDialog.dataset.editId = "";
      travelDialog.showModal();
    };
    root.append(add);

    const spacer = document.createElement("div"); spacer.className = "spacer";
    root.append(spacer);

    if (!travel.length) {
      const div = document.createElement("div"); div.className = "muted"; div.textContent = "No travel saved.";
      root.append(div);
      return;
    }

    const toYMD = (iso) => {
      if (!iso) return "";
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    };

    travel.forEach(t => {
      const row = document.createElement("div"); row.className = "item";
      const inner = document.createElement("div"); inner.className = "item-c";

      const left = document.createElement("div");
      const head = document.createElement("div"); head.className = "title";
      head.textContent = `[${t.type.toUpperCase()}] ${t.label}`;

      const sub = document.createElement("div"); sub.className = "muted"; sub.style.fontSize = "12px";
      const bits = [];
      if (t.confirmation) bits.push(`Conf#: ${t.confirmation}`);
      if (t.type === "hotel") {
        if (t.startISO) bits.push(`Check-in ${fmtDate(t.startISO)}`);
        if (t.endISO)   bits.push(`Check-out ${fmtDate(t.endISO)}`);
      } else {
        if (t.startISO) bits.push(`Start ${fmtDate(t.startISO)} ${fmtTime(t.startISO)}`);
        if (t.endISO)   bits.push(`End ${fmtDate(t.endISO)} ${fmtTime(t.endISO)}`);
      }
      sub.textContent = bits.join(" • ");

      if (t.details) {
        const d = document.createElement("div"); d.style.fontSize = "12px"; d.textContent = t.details;
        left.append(head, sub, d);
      } else {
        left.append(head, sub);
      }

      const tools = document.createElement("div"); tools.className = "tools";
      const edit = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "✏️" });
      edit.onclick = () => {
        t_type.value = t.type;
        t_label.value = t.label;
        t_conf.value = t.confirmation || "";
        t_details.value = t.details || "";
        if (t.type === "hotel") {
          t_startDate.value = toYMD(t.startISO);
          t_endDate.value   = toYMD(t.endISO);
          t_start.value = ""; t_end.value = "";
        } else {
          t_start.value = t.startISO ? new Date(t.startISO).toISOString().slice(0, 16) : "";
          t_end.value   = t.endISO   ? new Date(t.endISO).toISOString().slice(0, 16)   : "";
          t_startDate.value = ""; t_endDate.value = "";
        }
        updateTravelDateInputs();
        travelDialog.dataset.editId = t.id;
        travelDialog.showModal();
      };

      const del = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "🗑️" });
      del.onclick = async () => {
        if (!confirm("Delete this travel item?")) return;
        try { await deleteTravel(t.id); }
        catch (e) { console.error(e); alert("Delete failed: " + (e.code || e.message)); }
      };

      tools.append(edit, del);
      inner.append(left, tools);
      row.append(inner);
      root.append(row);
    });
  }

function renderLogo() {
  if (!logoUrl) {
    brandLogo.removeAttribute('src');
    brandLogo.classList.add('hidden');
    setLogoBtn?.classList.remove('hidden');
    return;
  }
  const probe = new Image();
  probe.onload = () => {
    brandLogo.src = logoUrl;
    brandLogo.classList.remove('hidden');
    setLogoBtn?.classList.add('hidden');
  };
  probe.onerror = () => {
    console.error('[logo] preview failed to load');
    brandLogo.removeAttribute('src');
    brandLogo.classList.add('hidden');
    setLogoBtn?.classList.remove('hidden');
  };
  probe.src = logoUrl;
}

function renderImportExport() {
  const root = document.createElement("div");

  const inp = document.createElement("input");
  inp.type = "file"; inp.accept = "application/json"; inp.className = "hidden";

  const btnImport = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "⬆️ Import" });
  const btnExport = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "⬇️ Export" });
  const btnWipeMeetings = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "🧹 Clear meetings" });
  const btnWipeTravel   = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "🧹 Clear travel" });

  btnImport.onclick = () => inp.click();
  btnExport.onclick = async () => {
    const exportObj = { meetings, travel, sessions };
    const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `export-${ymdInTZ(new Date().toISOString())}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  btnWipeMeetings.onclick = async () => {
    if (!confirm("Delete ALL meetings?")) return;
    try {
      const snap = await MEETINGS.get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      alert("Meetings cleared.");
    } catch (e) { console.error(e); alert("Delete failed: " + (e.code || e.message)); }
  };

  btnWipeTravel.onclick = async () => {
    if (!confirm("Delete ALL travel?")) return;
    try {
      const snap = await TRAVEL.get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      alert("Travel cleared.");
    } catch (e) { console.error(e); alert("Delete failed: " + (e.code || e.message)); }
  };

  inp.onchange = async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    try {
      const parsed = JSON.parse(await f.text());
      const meetingsIn = Array.isArray(parsed.meetings) ? parsed.meetings : [];
      const travelIn   = Array.isArray(parsed.travel)   ? parsed.travel   : [];
      const sessionsIn = Array.isArray(parsed.sessions) ? parsed.sessions : [];
      await Promise.all([
        ...meetingsIn.map(upsertMeeting),
        ...travelIn.map(upsertTravel),
        ...sessionsIn.map(upsertSession),
      ]);
      alert("Import complete.");
    } catch (err) {
      console.error(err);
      alert("Import failed: " + (err.message || "Invalid file"));
    } finally { e.target.value = ""; }
  };

  root.append(btnImport, " ", btnExport, " ", btnWipeMeetings, " ", btnWipeTravel, inp);

  const host = document.getElementById("importExport"); // correct ID
  if (host) { host.innerHTML = ""; host.append(root); }
}

  function renderAll() {
    renderHeaderControls();
    if (view === "agenda") {
      agendaList.classList.remove("hidden");
      hourlyGrid.classList.add("hidden");
      renderAgenda();
    } else {
      hourlyGrid.classList.remove("hidden");
      agendaList.classList.add("hidden");
      renderHourly();
    }
    renderDetails();
    const ds = $("#detailsStandalone");
    if (ds) renderDetails(ds, "all");
    renderTravel();
    renderLogo();
    renderImportExport();
  }

  // ========= Meeting dialog =========
  function renderAttendeeRow(a) {
    const wrap = document.createElement("div"); wrap.className = "ae"; wrap.dataset.id = a.id;
    const grid = document.createElement("div"); grid.className = "ae-grid";

    const avatar = document.createElement("div"); avatar.className = "ae-avatar";
    if (a.photoUrl) { const img = document.createElement("img"); img.src = a.photoUrl; avatar.append(img); }
    else { avatar.textContent = (a.name || "?").slice(0, 1).toUpperCase(); }

    const right = document.createElement("div"); right.className = "col gap8";

    const row1 = document.createElement("div"); row1.className = "ae-two";
    const inName = Object.assign(document.createElement("input"), { placeholder: "Full name", value: a.name || "", name: "a_name" });
    const inTitle= Object.assign(document.createElement("input"), { placeholder: "Job title", value: a.title || "", name: "a_title" });
    row1.append(inName, inTitle);

    const row2 = document.createElement("div"); row2.className = "ae-two";
    const inCompany = Object.assign(document.createElement("input"), { placeholder: "Company", value: a.company || "", name: "a_company" });
    const linkWrap = document.createElement("div"); linkWrap.className = "ae-linkwrap";
    const inLinkedin = Object.assign(document.createElement("input"), { placeholder: "LinkedIn URL (https://…)", value: a.linkedin || "", name: "a_linkedin" });
    const btnOpen = Object.assign(document.createElement("button"), { className: "btn sm", type: "button", textContent: "🔗 Open", disabled: !inLinkedin.value.trim() });
    btnOpen.onclick = () => { const url = sanitizeUrl(inLinkedin.value); if (!url) return; window.open(url, "_blank", "noopener,noreferrer"); };
    inLinkedin.addEventListener("input", () => { btnOpen.disabled = !inLinkedin.value.trim(); });
    linkWrap.append(inLinkedin, btnOpen);
    row2.append(inCompany, linkWrap);

    const rowContact = document.createElement("div"); rowContact.className = "ae-two";
    const inEmail = Object.assign(document.createElement("input"), { type: "email", placeholder: "Email", value: a.email || "", name: "a_email" });
    const inPhone = Object.assign(document.createElement("input"), { type: "tel", placeholder: "Phone", value: a.phone || "", name: "a_phone" });
    rowContact.append(inEmail, inPhone);

    const inPhotoHidden = Object.assign(document.createElement("input"), { type: "hidden", name: "a_photo", value: a.photoUrl || "" });
    const inPhotoFile = Object.assign(document.createElement("input"), { type: "file", accept: "image/*" });
    const btnClearPhoto = Object.assign(document.createElement("button"), { className: "btn sm", type: "button", textContent: "🧹 Clear photo", style: "margin-left:8px" });
    btnClearPhoto.onclick = () => { a.photoUrl = ""; inPhotoHidden.value = ""; avatar.innerHTML = (inName.value || "?").slice(0, 1).toUpperCase(); };
    inPhotoFile.addEventListener("change", async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      try {
        const dataUrl = await fileToDataUrl(file, { maxW: 256, maxH: 256, quality: 0.9 });
        a.photoUrl = dataUrl; inPhotoHidden.value = dataUrl;
        avatar.innerHTML = ""; const img2 = document.createElement("img"); img2.src = dataUrl; avatar.append(img2);
      } catch (err) { console.error(err); alert("Could not read that image. Try a PNG or JPG."); }
      finally { inPhotoFile.value = ""; }
    });
    inName.addEventListener("input", () => { if (!inPhotoHidden.value) avatar.textContent = (inName.value || "?").slice(0, 1).toUpperCase(); });

    const photoRow = document.createElement("div"); photoRow.className = "ae-two";
    const photoLeft = document.createElement("div"); const photoRight = document.createElement("div");
    photoLeft.append(inPhotoFile, btnClearPhoto); photoRow.append(photoLeft, photoRight);

    const inNotes = document.createElement("textarea"); inNotes.placeholder = "Notes"; inNotes.value = a.notes || "";

    const actions = document.createElement("div"); actions.className = "ae-actions";
    const btnRemove = Object.assign(document.createElement("button"), { className: "btn sm", textContent: "🗑️ Remove" });
    btnRemove.onclick = () => { currentAttendees = currentAttendees.filter(x => x.id !== a.id); renderAttendeeEditor(currentAttendees); };
    actions.append(btnRemove);

    right.append(row1, row2, rowContact, photoRow, inPhotoHidden, inNotes);
    grid.append(avatar, right);
    wrap.append(grid, actions);
    return wrap;
  }

  function renderAttendeeEditor(list) {
    attendeeEditorRoot.innerHTML = "";
    if (!list || !list.length) {
      const empty = document.createElement("div"); empty.className = "muted"; empty.textContent = "No attendees yet.";
      attendeeEditorRoot.append(empty); return;
    }
    list.forEach(a => attendeeEditorRoot.append(renderAttendeeRow(a)));
  }

  function collectAttendeesFromEditor() {
    const rows = Array.from(attendeeEditorRoot.querySelectorAll(".ae"));
    return rows.map(row => {
      const id = row.dataset.id;
      const v = (sel) => row.querySelector(sel)?.value?.trim() || "";
      return {
        id,
        name: v('input[name="a_name"]'),
        title: v('input[name="a_title"]'),
        company: v('input[name="a_company"]'),
        linkedin: v('input[name="a_linkedin"]'),
        email: v('input[name="a_email"]'),
        phone: v('input[name="a_phone"]'),
        photoUrl: v('input[name="a_photo"]'),
        notes: row.querySelector("textarea")?.value?.trim() || ""
      };
    });
  }

  function updateTbdUI() {
    const dateTBD = m_dateTBD.checked;
    const timeTBD = m_timeTBD.checked;
    if (dateTBD) { rowDateTimes.classList.add("hidden"); rowDateOnly.classList.add("hidden"); }
    else if (timeTBD) { rowDateTimes.classList.add("hidden"); rowDateOnly.classList.remove("hidden"); }
    else { rowDateTimes.classList.remove("hidden"); rowDateOnly.classList.add("hidden"); }
  }

  function openMeetingDialog(m) {
    meetingDialog.dataset.editId = m?.id || "";
    dlgTitle.textContent = m ? "Edit meeting" : "New meeting";
    m_title.value = m?.title || "";
    m_location.value = m?.location || "";
    m_booth.value = m?.booth || "";

    const toLocalInput = (d) => { const dt = new Date(d); dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset()); return dt.toISOString().slice(0, 16); };
    m_start.value = toLocalInput(m ? m.startISO : new Date());
    m_end.value   = toLocalInput(m ? m.endISO   : new Date(Date.now() + 60 * 60 * 1000));
    m_desc.value  = m?.description || "";

    m_dateTBD.checked = !!m?.dateTBD;
    m_timeTBD.checked = !!m?.timeTBD;

    if (!m_dateTBD.checked && m_timeTBD.checked) {
      const base = m?.startISO ? new Date(m.startISO) : new Date();
      m_dateOnly.value = `${base.getFullYear()}-${String(base.getMonth() + 1).padStart(2, '0')}-${String(base.getDate()).padStart(2, '0')}`;
    } else m_dateOnly.value = "";

    currentAttendees = Array.isArray(m?.attendees) ? structuredClone(m.attendees) : [];
    renderAttendeeEditor(currentAttendees);

    updateTbdUI();
    meetingDialog.showModal();
  }

  async function saveMeetingFromDialog() {
    const id = meetingDialog.dataset.editId;
    const dateTBD = m_dateTBD.checked;
    const timeTBD = m_timeTBD.checked;

    const base = {
      id: id || uid(),
      title: m_title.value.trim(),
      location: m_location.value.trim(),
      booth: m_booth.value.trim(),
      attendees: collectAttendeesFromEditor(),
      description: m_desc.value.trim(),
      dateTBD, timeTBD
    };
    if (!base.title) { alert("Title required"); return; }

    if (dateTBD) {
      base.startISO = new Date(0).toISOString();
      base.endISO   = new Date(60 * 60 * 1000).toISOString();
      base.dateOnly = "";
    } else if (timeTBD) {
      if (!m_dateOnly.value) { alert("Pick a date (or mark Date TBD)."); return; }
      const d = new Date(m_dateOnly.value);
      base.startISO = d.toISOString();
      base.endISO   = new Date(d.getTime() + 60 * 60 * 1000).toISOString();
      base.dateOnly = m_dateOnly.value;
    } else {
      if (!(m_start.value && m_end.value)) { alert("Start and end are required (or mark TBD)."); return; }
      const start = new Date(m_start.value), end = new Date(m_end.value);
      if (end <= start) { alert("End time must be after start time."); return; }
      base.startISO = start.toISOString();
      base.endISO   = end.toISOString();
      base.dateOnly = "";
    }

    const now = Date.now();
    if (!id) base.createdAtMs = now;
    base.updatedAtMs = now;

    try { await upsertMeeting(base); meetingDialog.close(); }
    catch (e) { console.error(e); alert('Cloud save failed.'); }
  }

  // ========= Travel dialog =========
  function saveTravelFromDialog() {
    const id = travelDialog.dataset.editId;
    const type = t_type.value;
    const label = (t_label.value || "").trim();

    if (!label) { alert("Label required"); return; }

    const base = {
      id: id || uid(),
      type,
      label,
      confirmation: (t_conf.value || "").trim(),
      details: (t_details.value || "").trim()
    };

    if (type === "hotel") {
      if (!t_startDate.value || !t_endDate.value) { alert("Check-in and Check-out are required."); return; }
      base.startISO = new Date(t_startDate.value).toISOString();
      base.endISO   = new Date(t_endDate.value).toISOString();
    } else {
      if (!t_start.value || !t_end.value) { alert("Start and End date/time are required."); return; }
      base.startISO = new Date(t_start.value).toISOString();
      base.endISO   = new Date(t_end.value).toISOString();
      if (new Date(base.endISO) <= new Date(base.startISO)) { alert("End must be after Start."); return; }
    }

    return upsertTravel(base).then(() => travelDialog.close())
      .catch(e => { console.error(e); alert("Save failed: " + (e.code || e.message)); });
  }

  // ========= Tabs & View =========
  function switchTopTab(name) {
    if (!TOP_TABS.includes(name)) name = "schedule";
    activeTopTab = name;
    localStorage.setItem("activeTopTab", name);

    const meetingsDescEl = document.querySelector('#view-meetings .card-h .desc');
    if (meetingsDescEl) {
      meetingsDescEl.textContent =
        (name === "meetings") ? "All upcoming meetings (includes Date-TBD)." : "All meeting cards for the active day.";
    }

    $("#view-schedule").classList.toggle("hidden", name !== "schedule");
    $("#view-travel").classList.toggle("hidden",   name !== "travel");
    $("#view-gpt").classList.toggle("hidden",      name !== "gpt");
    $("#view-meetings").classList.toggle("hidden", name !== "meetings");

    $$("#topTabs .tab").forEach(btn => btn.classList.toggle("active", btn.dataset.toptab === name));

    renderAll();
  }

  // ========= Wiring =========


  logoFile?.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    let dataUrl = '';
    try {
      dataUrl = await fileToDataUrl(file, { maxW: 360, maxH: 120, quality: 0.9 });
      if (dataUrl.length > 750_000) { alert('Logo is too large after resize. Try a smaller image.'); e.target.value = ''; return; }
      logoUrl = dataUrl; renderLogo();
      await setSharedDoc('logoUrl', dataUrl);
    } catch (err) {
      console.error('[logo] save failed', err);
      alert('Could not save logo: ' + (err.code || err.message || 'unknown error'));
    } finally {
      e.target.value = '';
    }
  });
document.addEventListener('click', async (e) => {
  // top tabs
  const tabBtn = e.target.closest('#topTabs .tab');
  if (tabBtn && tabBtn.dataset.toptab) {
    switchTopTab(tabBtn.dataset.toptab);
    return;
  }

  // date nav
  if (e.target.closest('#prevDay')) { shiftDay(-1); return; }
  if (e.target.closest('#nextDay')) { shiftDay(1);  return; }

  // agenda/hourly toggle
  if (e.target.closest('#tabAgenda')) { view = 'agenda'; renderAll(); return; }
  if (e.target.closest('#tabHourly')) { view = 'hourly'; renderAll(); return; }

  // meeting add (both places)
  if (e.target.closest('#addMeetingBtn')) { openMeetingDialog(); return; }
  if (e.target.closest('#mtabAddMeeting')) { openMeetingDialog(); return; }

  // travel collapse
  if (e.target.closest('#travelCollapseBtn')) {
    setTravelCollapsed(!travelSection.classList.contains('hidden'));
    return;
  }

  // logo dialog open
  if (e.target.closest('#setLogoUrlBtn')) { logoDialog.showModal(); return; }

  // logo dialog actions
  if (e.target.closest('#logoCancel')) { logoDialog.close(); return; }

  if (e.target.closest('#logoSave')) {
    let url = (logoInput.value || '').trim();
    if (!url) { logoDialog.close(); return; }
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    try { await setSharedDoc('logoUrl', url); logoUrl = url; renderLogo(); }
    catch (err) { alert('Could not save logo: ' + (err.code || err.message || 'unknown error')); }
    finally { logoDialog.close(); }
    return;
});

  onSharedDoc('logoUrl', v => { logoUrl = v || ""; renderLogo(); });

  // GPT link
  onSharedDoc('gptUrl', v => { gptUrl = v || ""; });
  openGptBtn.onclick = () => {
    if (gptUrl && /^https?:\/\//i.test(gptUrl)) window.open(gptUrl, "_blank", "noopener,noreferrer");
    else { gptInput.value = gptUrl || ""; gptDialog.showModal(); }
  };
  gptSave.onclick = async () => {
    let url = (gptInput.value || "").trim();
    if (!url) { gptDialog.close(); return; }
    if (!/^https?:\/\//i.test(url)) url = "https://" + url;
    try { await setSharedDoc("gptUrl", url); gptUrl = url; }
    catch (err) { alert("Could not save GPT link: " + (err.code || err.message || "unknown error")); }
    finally { gptDialog.close(); }
  };
  gptCancel.onclick = () => gptDialog.close();

  // chat
  chatForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const content = chatInput.value.trim();
    if (!content) return;
    appendMsg("user", content);
    chatInput.value = ""; chatInput.disabled = true; chatSend.disabled = true;

    const ctx = {
      date: fmtDate(activeDate),
      meetings: itemsForDay(activeDate).filter(x => x.kind === "meeting").map(m => ({
        title: m.title,
        start: m.timeTBD ? "TBD" : fmtTime(m.startISO),
        end:   m.timeTBD ? "TBD" : fmtTime(m.endISO),
        location: displayLocation(m) || "",
        booth: m.booth || ""
      })),
      travel: travel.map(t => ({ type: t.type, label: t.label, start: t.startISO || "", end: t.endISO || "" }))
    };

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: content, context: ctx })
      });
      if (!res.ok) throw new Error("Request failed");
      const data = await res.json();
      appendMsg("assistant", data.reply || "(no reply)");
    } catch (err) {
      console.error(err);
      appendMsg("assistant", "Sorry, I couldn’t reach the assistant.");
    } finally {
      chatInput.disabled = false; chatSend.disabled = false; chatInput.focus();
    }
  });

  // ========= Live subscriptions + init =========
async function init() {
  try {
    gptUrl  = (await getSharedDoc('gptUrl', "")) || "";
    logoUrl = (await getSharedDoc('logoUrl', "")) || "";
  } catch (err) {
    console.warn('Shared docs not available yet:', err);
  }
  renderLogo();

 try {
  MEETINGS.orderBy('startISO').onSnapshot(snap => {
    meetings = snap.docs.map(d => d.data());
    if (!autoPickedDayOnce) {
      const days = daysFromCalendar();
      const pick = pickMostCurrentDay(days);
      if (pick) activeDate = pick;
      autoPickedDayOnce = true;
    }
    renderAll();
  });

  TRAVEL.orderBy('startISO').onSnapshot(snap => {
    travel = snap.docs.map(d => d.data());
    renderAll();
  });

  SESSIONS.orderBy('startISO').onSnapshot(snap => {
    sessions = snap.docs.map(d => d.data());
    renderAll();
  });
} catch (err) {
  console.warn('Firestore wiring failed; running in local-only mode:', err);
}


  // Always render and enable tabs regardless of Firebase status
  renderAll();
  switchTopTab(activeTopTab || 'schedule');



  // kick off
  init();
})();
</script>
</body>
</html>
